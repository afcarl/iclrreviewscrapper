"use strict";function httpGet(e,n,t,i){controller.get(e,n,t,i)}function $attach(e,n,t,i){var r=guestContainer(e),a=view[n].apply(view,t);i?r.append(a):r.prepend(a)}function mkStateManager(){var e=Object.create(null),n=Object.create(null);return{addHandler:function(t,i){var r={};r[t]=i,e=_.assign(e,r),_.forEach(i,function(e,t){e(n[t])})},removeHandler:function(n){e=_.omit(e,n)},removeAllBut:function(n){var t=Object.create(null);n in e&&(t[n]=e[n]),e=t},update:function(t,i){var r={};r[t]=i,n=_.assign(n,r),_.forEach(e,function(e){e[t]&&e[t](i)})},has:function(e){return _.has(n,e)},get:function(e){return _.cloneDeep(n[e])},keys:function(){return _.keys(n)},clean:function(){n=Object.create(null)}}}var replaceWithActivation=function(e,n){history.replaceState({},"activation","/activate?"+serializeUrlParams({token:e})),runActivation(e)},pushActivation=function(e,n){history.pushState({},"activation","/activate?"+serializeUrlParams({token:e})),runActivation(e)},runActivation=function(e,n){var t=$("#content").empty();controller.get("/activatable/"+e,{},function(i){i.activatable;var r=formatProfileData(i.profile),a=$("<header>").append($("<h1>").text("Complete Registration"),$("<h5>").text("Enter your full name and current institution to complete your registration. All other fields are optional.")),o=buildProfileController(r,{buttonText:"Register for OpenReview",activation:!0,prefixedPositions:i.prefixed_positions,prefixedRelations:i.prefixed_relations,institutions:i.institutions},function(n){controller.put("/activate/"+e,n,function(e){promptMessage("Your OpenReview profile has been successfully created."),controller.update("token",e.token),mainApp.goToTasks()})});n(o),OpenBanner.hide(),t.append($("<div>",{class:"profile-controller"}).append(a,o.view))}).fail(function(){replaceWithHome()})};$(document).ready(function(){$.widget("custom.autocomplete_mod",$.ui.autocomplete,{_renderItem:function(e,n){var t=$("<li>",{class:"menuItem"}).attr("section",n.section),i=n.label;if(t.append($("<div>").append(i)),n.hasOwnProperty("subtitle")){var r=n.subtitle;t.append($("<div>",{class:"authlist"}).append(r))}return t.appendTo(e),t},_renderMenu:function(e,n){for(var t=this,i=n[0].section,r=0;r<n.length;r++)n[r].section!==i&&(e.append("<hr>"),i=n[r].section),t._renderItemData(e,n[r])}}),runAutocomplete($("#search_input"))});var OpenBanner=function(){this._id="#or-banner",this._elem=$(this._id+" div.col-xs-12")};OpenBanner.prototype.clear=function(){this._elem.empty()},OpenBanner.prototype.hide=function(){return $("#content").removeClass("openbanner-visible"),$(this._id).slideUp().promise()},OpenBanner.prototype.show=function(){return $(this._id).slideDown(function(){$("#content").addClass("openbanner-visible")}).promise()},OpenBanner.prototype.welcome=function(){this.set('<span class="tagline">Open Peer Review. Open Publishing. Open Access. Open Discussion. Open Directory. Open Recommendations. Open API. Open Source.</span>')},OpenBanner.prototype.set=function(e){this._elem.html(e)},OpenBanner.prototype.breadcrumbs=function(e){var n=function(e){e.class=e.class?e.class:"","/"===e.link&&(e.class+=" home");var n,t;return e.link?(n='<a href="'+e.link+'" class="'+e.class+'">',t="</a>"):(n='<span class="'+e.class+'">',t="</span>"),"<li>"+n+e.text+t+"</li>"};if(_.isArray(e)){var t=_.map(e,n).join("\n");this._elem.html('<ol class="breadcrumb">'+t+"</ol>")}else this._elem.find("ol.breadcrumb").append(n(e))};var idClass="caja-guest-0___",guestContainer=function(e){return $(e)},user,args,cajaManager={run:function(e,n,t,i){user=t,args=i,$(e).html(n)}},replaceWithConfirm=function(e){history.replaceState({email:e},"confirm","/confirm"),runConfirm(e)},pushConfirm=function(e){history.pushState({email:e},"confirm","/confirm"),runConfirm(e)},runConfirm=function(e){var n=$("#content"),t={token:function(t){var i=model.tokenPayload(t);if(n.empty(),i.user&&i.user.id&&!_.startsWith(i.user.id,"guest_"))controller.removeHandler("confirm"),pushTasks();else{var r=$("<h1>").text("Sign up in progress: Check your inbox"),a=$("<div>",{class:"panel"}).append($("<div>",{class:"row"}).append($("<span>",{class:"important_message"}).text("Email was sent to "),$("<span>",{class:"important_term"}).text(e),$("<span>",{class:"important_message"}).text(" with subject “OpenReview signup confirmation”.\n"),$("<span>",{class:"important_message"}).text("Please click on the link in this email to confirm your email address and complete your sign up.")));n.append($("<div>",{class:"panel"}).append(r,a))}}};controller.addHandler("confirm",t)},controller=function(){var e=mkStateManager(),n=e.addHandler,t=e.update,i=function(n,i){return function(r,a,o,s,l){l||t("loadingCount",(e.get("loadingCount")||0)+1);var d=e.get("token")?{Authorization:"Bearer "+e.get("token")}:{};return $.ajax({cache:!0,dataType:"json",type:n,contentType:i?"application/json; charset=UTF-8":"application/x-www-form-urlencoded; charset=UTF-8",url:r,data:i?JSON.stringify(a):a,headers:d,timeout:2e4}).then(function(e){return"function"==typeof o?o(e):e},function(e,n,t){console.warn("Xhr Error: "+t+": "+n),console.warn("jqXhr: "+JSON.stringify(e,null,2));var i=e.responseJSON,r="Something went wrong";if("timeout"===n)return r="OpenReview is currently under heavy load. Please try again soon.",void promptError(r);if(i&&(i.errors&&i.errors.length?r=i.errors[0]:i.message&&(r=i.message)),"User does not exist"===r)location.reload(!0);else{if("function"==typeof s)return s(e,r);promptError(r)}}).always(function(){if(!l){var n=e.get("loadingCount")-1;t("loadingCount",n>0?n:0)}})}},r=i("post",!0),a=i("get",!1),o=i("patch",!0),s=i("put",!0),l=function(e){a("/token",{},e)};return{addHandler:n,removeHandler:function(n){t("loadingCount",0),e.removeHandler(n)},removeAllButMain:function(){t("loadingCount",0);var n=$("#content");n.length&&n.empty(),e.removeAllBut("main")},update:t,postUser:function(e,n,t){r("/register",{id:e,password:n},t,function(e,n,t){var i=e.responseJSON.errors;promptError(i&&"forbidden"===i[0].type?"User with email address already exists":i?i[0]:"Something went wrong")})},getToken:l,login:function(e,n,i){return r("/login",{id:e,password:n},function(e){t("token",e.token),i(e.token)})},logout:function(n){return r("/logout",{},function(i){e.clean(),l(function(e){t("token",e.token),n&&n(e)})})},post:r,get:a,patch:o,put:s,sendFile:function(n,t){return $.ajax({url:n,type:"put",cache:!1,dataType:"json",processData:!1,contentType:!1,data:t,headers:{Authorization:"Bearer "+(e.has("token")?e.get("token"):"")}}).fail(function(e,n,t){console.warn("Xhr Error: "+t+": "+n),console.warn("jqXhr: "+JSON.stringify(e,null,2))})}}}(),replaceWithForum=function(e,n,t){history.replaceState({noteId:n,invitationId:t},"forum","/forum?"+serializeUrlParams({id:e,noteId:n})),runForum(e,n,t)},pushForum=function(e,n,t){history.pushState({noteId:n,invitationId:t},"forum","/forum?"+serializeUrlParams({id:e,noteId:n})),runForum(e,n,t)},runForum=function(e,n,t){$("body")[0].className="forum";var i,r=mkStateManager();n&&n!==e&&(i="#note_"+n);var a=$("#content"),o=a,s=o.hasClass("pre-rendered")?$("#note_children"):$("<div>",{id:"note_children"}),l=function(e){var n=_.without(_.uniq(_.map(e,function(e){return e.tauthor})),void 0);return n.length?controller.post("user/profiles",{emails:n}).then(function(n){var t={};return _.forEach(n.profiles,function(e){t[e.email]=e.profile}),_.map(e,function(e){var n=t[e.tauthor];return _.assign(e,n?{tauthor:n.id}:{})})}):$.Deferred().resolve(e).promise()},d=function(){var n=e?controller.get("notes",{forum:e,trash:!0}).then(function(e){if(e.notes.length>0){var n=_.filter(e.notes,function(e){return e.forum===e.id}),t=(n=n[0]).invitation.split("/-/")[0],i={link:"/group?id="+t,text:view.prettyId(t)};return n.content.venue&&(i={text:n.content.venue}),OpenBanner.breadcrumbs([{link:"/",text:"Venues"},i]),$("#search_group").val(t),$("#search_input").val(""),$("#search_input").attr("placeholder","Search "+view.prettyId(t)),$("#search_content").val("all"),l(e.notes)}controller.removeHandler("note"),replaceWithHome()}):$.Deferred().resolve([]).promise(),t=e?controller.get("invitations",{replyForum:e}).then(function(e){return e.invitations}):$.Deferred().resolve([]).promise(),i=function(e){return e?controller.get("invitations",{replyInvitation:e,tags:!0}).then(function(e){return e.invitations}):$.Deferred().resolve([]).promise()},r=function(e){return e?controller.get("invitations",{replyForum:e}).then(function(e){return e.invitations}):$.Deferred().resolve([]).promise()};return n.fail(function(){controller.removeHandler("note"),replaceWithHome()}),$.when(n,t).then(function(n,t){var a=_.filter(t,function(e){return!(_.has(e.reply,"replyto")&&null!==e.reply.replyto||_.has(e.reply,"referent")&&null!==e.reply.referent)}),o=_.map(n,function(n){var o=_.filter(t,function(e){return e.reply.replyto===n.id}),s=_.filter(t,function(e){return e.reply.referent===n.id}),l=_.filter(a,function(e){var t=!e.reply.selfReplyOnly||e.reply.selfReplyOnly&&e.id===n.invitation;return _.has(e.reply,"invitation")?e.reply.invitation===n.invitation||t:n.id===e.reply.forum||t}),d=_.union(l,o);return $.when(i(n.id===e?n.invitation:void 0),r(n.original)).then(function(e,t){return{note:n,replyInvitations:d,referenceInvitations:s,tagInvitations:e,originalInvitations:t}})});return $.when.apply($,o).then(function(){return _.toArray(arguments)})})};e?(controller.addHandler("forum",{token:function(l){function p(n,t,i){view.mkNewNoteEditor(n,e,t,f,{onNoteCreated:function(e){e.id,d().then(function(e){r.update("noteRecs",e)})},onCompleted:function(e){i(e)}})}function c(e,n){var t=view.mkNotePanel(e.note,{onEditRequested:function(i){u(e,i,n,function(e){t.replaceWith(e)})},withContent:!0,withRevisionsLink:!0,withOriginalLink:!0,withOverwritingLink:!0,withModificationDate:!0,replyInvitations:e.replyInvitations,referenceInvitations:e.referenceInvitations,onNewNoteRequested:function(t){n.prepend(Handlebars.templates.spinner({extraClasses:"spinner-inline"})),p(t,e.note&&e.note.id,function(e){n.find(".spinner-container").fadeOut("normal",function(){$(this).remove(),n.prepend(e)})})},onTrashedOrRestored:function(e){r.update("noteRecs",_.map(r.get("noteRecs"),function(n){return n.note.id===e.id?_.assign(n,{note:e}):n}))},userId:f&&f.id,user:f,tagInvitations:e.tagInvitations,originalInvitations:e.originalInvitations}).attr("id","note_"+e.note.id);return t}function u(e,n,t,i){function a(n){view.mkNoteEditor(e.note,n,f,{onNoteEdited:function(e){d().then(function(e){r.update("noteRecs",e)})},onNoteCancelled:function(){o.replaceWith(c(e,t))},onCompleted:function(e){o=e,i(e)}})}var o=null;n?a(n):controller.get("invitations",{id:e.note.invitation},function(e){a(e.invitations[0])})}var f=model.tokenPayload(l).user;d().done(function(i){if(r.update("noteRecs",i),n&&e!==n&&!t&&r.update("noteId",n),t){var a=e===n?e:n,o=_.find(i,function(e){return e.note.id===a});if(o){var s=_.find(o.replyInvitations,{id:t});r.update("invitation",s)}}});r.addHandler("forum",{noteRecs:function(n){var t=_.find(n,function(e){return e.note.id===e.note.forum});if(t){var r=c(t,s),l=1===t.note.replyCount?"1 Reply":t.note.replyCount+" Replies";r.find("div.reply_row").eq(0).prepend('<div class="item" id="reply_count">'+l+"</div>"),o.empty().append(r,"<hr>",s),a.removeClass("pre-rendered"),$('[data-toggle="tooltip"]').tooltip();var d=t.note.content.title||"Forum";if(document.title=d+" | OpenReview",s.empty().append(function(){var t=_.groupBy(n,function(e){return e.note.replyto}),i=function(e){if(e&&e.length>0)return _.map(_.sortBy(e,function(e){return-1*e.note.tcdate}),function(e){var n=e.note,r=$("<div>",{class:"children"}).append(i(t[n.id])),a=c(e,r);return $("<div>",{class:"note_with_children"}).append(a,r)})};return i(t[e])}()),i&&$(i).length){var p=$(i).offset().top-51-12;$("html, body").animate({scrollTop:p},600),i=null}}},note:function(e){var n=e?e.id:null;if(n){var t=s.find("#note_"+n);t.css("background-color","ccccff"),a.animate({scrollTop:t.offset().top-a.offset().top}),window.setTimeout(function(){t.animate({backgroundColor:"white"},"slow")},1e3)}},invitation:function(t){if(t)if(e===n)s.prepend(Handlebars.templates.spinner({extraClasses:"spinner-inline"})),p(t,n,function(e){s.find(".spinner-container").fadeOut("normal",function(){s.prepend(e)})});else if(n&&e!==n){var i=$("#note_"+n),r=i.next(".children");r.prepend(Handlebars.templates.spinner({extraClasses:"spinner-inline"})),p(t,n,function(e){r.find(".spinner-container").fadeOut("normal",function(){r.prepend(e),e.css("background-color","ccccff"),a.animate({scrollTop:i.offset().top-a.offset().top})})})}}})}}),OpenBanner.show()):replaceWithHome()},replaceWithGroup=function(e){history.replaceState({},"group","/group?"+serializeUrlParams({id:e})),runGroup(e)},pushGroup=function(e){history.pushState({},"group","/group?"+serializeUrlParams({id:e})),$("body")[0].className="group",runGroup(e)},runGroup=function(e){if(!e)return controller.removeHandler("group"),void replaceWithHome();document.title=view.prettyId(e)+" | OpenReview";var n=$("#content").empty(),t=$("<div>",{id:"group-container"});n.append(t);controller.addHandler("group",{token:function(n){t.empty();var i=model.tokenPayload(n).user||null;$("#search_group").val(e),$("#search_input").attr("placeholder","Search "+view.prettyId(e));controller.get("groups",{id:e},function(e){if(_.has(e,"groups[0].web")){var n=e.groups[0].web;-1===n.indexOf('<script type="text/javascript">')&&Webfield.validate(n)?Webfield.execute(n,i):cajaManager.run(t[0],n,i)}else console.warn("No webfield code found.")},function(n,t){var i=n.responseJSON?n.responseJSON.errors:null;if(i){var r=i[0];"forbidden"!==r.type&&promptError(r)}else promptError("The group "+e+" could not be loaded");replaceWithHome()})}}),OpenBanner.show()},replaceWithHome=function(){history.replaceState({},"home","/"),runHome()},pushHome=function(){history.pushState({},"home","/"),runHome()},runHome=function(){$("body")[0].className="home",$("#content").addClass("legacy-styles"),document.title="Venues | OpenReview",OpenBanner.welcome(),$("#flash-message-container").find(".profile-flash-message").length&&$("#flash-message-container").slideUp();var e=$("#content").empty(),n=function(e){return $("<h2>").append($("<a>",{href:"/group?id="+e,text:view.prettyId(e)}))},t=function(e,n){var t=n.toLocaleDateString("en-GB",{hour:"numeric",minute:"numeric",day:"2-digit",month:"short",year:"numeric",timeZoneName:"long"});return $("<h2>").append($("<a>",{href:"/group?id="+e,text:view.prettyId(e)}),$("<div>",{class:"invitation_duedate",text:"Due: "+t}))},i=controller.get("groups",{id:"host"}).then(function(e){return e.groups[0].members}),r=controller.get("invitations",{regex:".*/-/submission",minduedate:Date.now()}).then(function(e){return _.filter(e.invitations,function(e){return e.duedate})});$.when(i,r).done(function(i,r){e.append("<h1>Open for Submissions</h1><hr>");var a=$('<div class="conferences">');r.length?r.forEach(function(e){a.append(t(e.id.split("/-/")[0],new Date(e.duedate)))}):a.append($("<div>",{text:"No venues are currently accepting submissions"})),e.append(a),e.append("<h1>All Venues</h1><hr>");var o=$('<div class="conferences">');i.forEach(function(e){o.append(n(e))}),e.append(o)}),$("#search_group").val("all"),$("#search_content").val("all"),$("#search_input").val(""),$("#search_input").attr("placeholder","Search OpenReview");var a={token:function(e){var n=model.tokenPayload(e);if(n.user&&n.user.profile){var t=n.user.profile,i=Handlebars.templates.userMenu({user:t});$("#user-menu").remove(),$("#navbar ul.navbar-nav").append(i)}}};controller.addHandler("home",a),OpenBanner.show()},mainApp;$(function(){$("a.home").on("click",function(){return!!$("body").hasClass("matching-browser")||(pushHome(),!1)}),$("#flash-message-container button.close").on("click",function(){$("#flash-message-container").slideUp()}),$(document).on("click",function(e){$(e.target).closest(".dropdown").length||$(".dropdown .dropdown_content").hide()}),$("#content").on("show.bs.collapse",function(e){var n=$(e.target).prev();n.hasClass("note-contents-toggle")&&n.text("Hide paper details")}),$("#content").on("hide.bs.collapse",function(e){var n=$(e.target).prev();n.hasClass("note-contents-toggle")&&n.text("Show paper details")});$("#feedback-modal").on("shown.bs.modal",function(){$(this).find(".feedback-input").focus()}),$("#feedback-modal .btn-primary").on("click",function(){$("#feedback-modal form").submit()}),$("#feedback-modal form").on("submit",function(){var e=$(this).attr("action"),n={};return $.each($(this).serializeArray(),function(e,t){n[t.name]=t.value||""}),$.ajax({type:"PUT",url:e,dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(n)}).done(function(e,n,t){"ok"===e.status?$("#feedback-modal p").text("Successfully submitted feedback."):$("#feedback-modal p").text("There was an error submitting feedback."),setTimeout(function(){$("#feedback-modal").modal("hide")},2e3)}),!1});$("#navbar .profile-search").on("submit",function(){var e=_.trim($("#search_input").val()),n=$("#search_group").val(),t=$("#search_content").val();if(!e)return $("#navbar .profile-search-results").hide(),!1;if(e.length<3)return $("#navbar .profile-search-results").hide(),promptError("Search term must be at least 3 characters long"),!1;var i={term:e,content:t,group:n,source:"all"};return window.legacyScripts?pushSearchResults(i):window.location.href="/search?"+$.param(i),!1}),window.OpenBanner=new OpenBanner,$("#content").on("click","a.action-bibtex-modal",function(){var e=$(this).data("bibtex"),n=Handlebars.templates["partials/bibtexModal"]({bibtexContent:e});return $("#bibtex-modal").remove(),$(document.body).append(n),$("#bibtex-modal pre.bibtex-content").on("click",function(){window.getSelection().selectAllChildren($(this)[0])}),$("#bibtex-modal").modal(),!1}),controller.getToken(function(e){controller.update("token",e.token),mainApp=runMain(),window.legacyScripts&&mainApp.route({}),window.onpopstate=function(e){console.log("event.state",e.state),mainApp.onpopstate(e.state||{})}})});var pushInvitation=function(e,n){history.pushState({invitationId:e,args:n},"invitation","/invitation?"+serializeUrlParams({id:e})),runInvitation(e,n)},runInvitation=function(e,n){$("body")[0].className="invitation";var t=!1;if(e){var i=$("#content").empty(),r=$("<div>",{id:"invitation-container"});r.append(Handlebars.templates.spinner()),i.append(r);controller.addHandler("invitation",{token:function(i){if(t)window.location.reload();else{var a=model.tokenPayload(i).user||null,o=controller.get("invitations",{id:e}).then(function(e){return e.invitations[0]});o.fail(function(){replaceWithHome()}),$.when(o).done(function(e){var i=!0,o=_.extend({},n);r.find(".spinner-container").remove();var s=e.web;if(-1===s.indexOf('<script type="text/javascript">')&&Webfield.validate(s)?Webfield.execute(s,a):cajaManager.run(r[0],s,a,_.assign(n,{invitation:e})),n&&_.without(_.keys(n),"id","invitation").length){var l=null;view.mkNoteEditor({parent:n.parent,content:o},e,a,{onNoteEdited:function(t){cajaManager.run(r[0],e.web,a,_.assign(n,{invitation:e,noteId:t.id}))},onNoteCancelled:function(e){replaceWithHome()},onError:function(e,n,t){if(console.log("onError",e.responseJSON),i)i=!1,l&&r.append(l);else{var a=e.responseJSON?e.responseJSON.errors:null;promptError(a?a[0]:"Something went wrong")}},onCompleted:function(e){(l=e).find('button:contains("Submit")').click(),t=!0}})}})}}})}else controller.removeHandler("invitation"),replaceWithHome()},replaceWithLogin=function(e){history.replaceState({},"login","/login"),runLogin(e)},pushLogin=function(e){history.pushState({},"login","/login"),runLogin(e)},runLogin=function(e){$("body")[0].className="login",$("#content").addClass("legacy-styles");var n=$("#content"),t=function(){var n=$("#content .btn-login");if(n.hasClass("disabled"))return!1;n.addClass("disabled").prop("disabled",!0).append(['<div class="spinner-small">','<div class="rect1"></div><div class="rect2"></div>','<div class="rect3"></div><div class="rect4"></div>',"</div>"].join("\n")),controller.login($("#email_input").val(),$("#password_input").val(),function(){_.isFunction(e)?e():replaceWithTasks()}).always(function(){n.removeClass("disabled").prop("disabled",!1).find(".spinner-small").remove()})},i={token:function(e){var i=model.tokenPayload(e);if(n.empty(),i.user&&i.user.id&&!_.startsWith(i.user.id,"guest_"))controller.removeHandler("login");else{var r=$("<h1>").text("Login"),a=$("<div>",{class:"panel"}).append($("<div>",{class:"row"}).append(view.mkSmallHeading("Email"),$("<input>",{class:"form-control",type:"text",id:"email_input"})),$("<div>",{class:"row"}).append(view.mkSmallHeading("Password"),$("<input>",{class:"form-control",type:"password",id:"password_input"}).keydown(function(e){if(13===e.keyCode)return t(),!1})),$("<div>",{class:"row"}).append($('<button type="button" class="btn btn-login">Login to OpenReview</button>').click(t)),$("<div>",{class:"row"}).append($("<a>",{class:"item important_term",text:"Forgot your password?"}).click(function(){controller.post("resettable",{id:$("#email_input").val()},function(){controller.removeHandler("login"),pushResetConfirm($("#email_input").val())})}),$("<br>"),$("<a>",{class:"item important_term",text:"Didn't receive email confirmation?"}).click(function(){controller.post("activatable",{id:$("#email_input").val()},function(){controller.removeHandler("login"),pushConfirm($("#email_input").val())})}))),o=$("<h1>").text("New User?"),s=$("<div>",{class:"panel"}).append($('<button type="button" class="btn row">Sign Up</button>').click(function(){controller.removeHandler("login"),pushSignup()}));n.append($("<div>",{class:"panel",id:"login_panel"}).append(r,a),$("<div>",{class:"panel",id:"signup_panel"}).append(o,s))}}};controller.addHandler("login",i)},runMain=function(){var e,n="main",t=function(){a("login")&&controller.logout(function(){n="login",history.back()})},i=function(){controller.removeAllButMain(),n="login",runLogin(function(){var e=document.cookie.replace(/(?:(?:^|.*;\s*)redirect\s*\=\s*([^;]*).*$)|^.*$/,"$1");e?(document.cookie="redirect=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",window.location=window.location.origin+decodeURIComponent(e)):history.back()})},r=function(t){controller.removeAllButMain(),runActivation(t,function(t){e=t,n="profile"})},a=function(t){return"profile"!==n||e&&e.canExit()},o=function(e){var n=document.location.pathname.substring(1),a=parseUrlParams(document.location.search);if(OpenBanner.show(),"forum"===n){var o=a.id||null,s=e.noteId||a.noteId||null,l=e.invitationId||a.invitationId||null;runForum(o,s,l)}else if("revisions"===n)runRevisions(a.id,a.left,a.right);else if("tasks"===n)runTasks();else if("profile"===n)runProfile(a);else if("login"===n)i();else if("logout"===n)t();else if("signup"===n)runSignup();else if("confirm"===n)runConfirm(e.email);else if("resetConfirm"===n)runResetConfirm(e.email);else if("group"===n){var d=a.id;runGroup(d)}else"invitation"===n?runInvitation(a.id,a):"index.html"===n?replaceWithHome():"search"===n?runSearchResults(a):"activate"===n?r(a.token):"reset"===n?runReset(a.token):"loginas"===n?controller.addHandler("supertoken",{token:function(e){var n=a.group;controller.get("impersonate",{group:n},function(e){controller.update("token",e.token),controller.removeHandler("supertoken"),history.back()})}}):"activatelink"===n?controller.put("activatelink/"+a.token,{},function(){promptMessage("Thank you for confirming your email"),replaceWithHome()}):replaceWithHome();document.getElementsByTagName("body")[0].className=n||"home"},s={token:function(e){var n=model.tokenPayload(e);if(n.user&&n.user.profile){var t=n.user.profile,i=Handlebars.templates.userMenu({user:t});$("#user-menu").remove(),$("#navbar ul.navbar-nav").append(i)}},loadingCount:function(e){e>0?$("#loading").show():$("#loading").hide()}};return controller.addHandler("main",s),{route:o,onpopstate:function(e){a()&&(o(e),n="state")},goToLogin:i,goToHome:function(){a("home")&&(controller.removeAllButMain(),pushHome(),n="main")},goToTasks:function(){a("tasks")&&(controller.removeAllButMain(),pushTasks(),n="tasks")},goToSearchResults:function(e){a("search")&&(pushSearchResults(e),n="search")}}},serializeUrlParams=function(e){return decodeURIComponent($.param(_.omitBy(e,_.isNil)))},parseUrlParams=function(e){return"string"!=typeof e?{}:(e=e.trim().replace(/^\?/,""))?e.trim().split("&").reduce(function(e,n){var t=n.replace(/\+/g," ").split("=");return e[t[0]]=void 0===t[1]?null:decodeURIComponent(t[1]),e},{}):{}},translateErrorMessage=function(e){var n=e.path?[view.iTerm(e.path)]:"",t={expired:[view.iMess(" has expired")],notString:[view.iMess(" is not a string")],notEmail:[view.iMess(" is not a valid email address")],notValidSyntax:[view.iMess(" does not meet syntax requirements")],notArray:[view.iMess(" is not an array")],notObject:[view.iMess(" is not an object")],forbidden:[view.iMess(" is not accessible by user "),view.iTerm(e.user)],notSignatory:_.isEmpty(e.value)?[view.iMess(" is missing")]:[view.iMess(" does not have signatory user "),view.iTerm(e.user)],notForum:[view.iMess(" is not a forum of "),view.iTerm(e.value2),view.iMess(" in "),view.iMess(e.path2)],notMatch:[view.iMess(" does not meet requirements")],missing:[view.iMess(" is missing")],"Not Found":[view.iMess(" could not be found")]};return _.has(t,e.type)?_.flatten([n,t[e.type]]):_.isString(e)?view.iMess(e):view.iMess("Something went wrong :(")},flashMessageTimer,generalPrompt=function(e,n,t){var i={html:!1,noTimeout:!1};t=_.assign(i,t);var r=$("#flash-message-container");r.hide(),"error"===e?r.removeClass("alert-success alert-warning").addClass("alert-danger"):"message"===e?r.removeClass("alert-danger alert-warning").addClass("alert-success"):"info"===e&&r.removeClass("alert-danger alert-success").addClass("alert-warning"),clearTimeout(flashMessageTimer),r.find(".alert-content span.important_message, .alert-content span.important_term, .alert-content strong").remove();var a;if(t.html)a=n;else if("error"===e){var o=t.hideErrorLabel?null:"<strong>Error: </strong>";a=_.flatten([o,translateErrorMessage(n)])}else a=view.iMess(n);r.find(".alert-content").append(a),r.slideDown();var s=$("#or-banner").is(":visible")?$("#or-banner").outerHeight():0;window.scrollY>s&&$("html, body").animate({scrollTop:s},400),t.noTimeout||(flashMessageTimer=setTimeout(function(){r.slideUp()},8e3))},promptError=function(e,n){generalPrompt("error",e,n)},promptMessage=function(e,n){generalPrompt("message",e,n)},promptLogin=function(e){_.isEmpty(e)||_.startsWith(e.id,"guest_")?generalPrompt("message",'<span class="important_message">Please <a href="/login">Login</a> to proceed</span>',{html:!0}):generalPrompt("message",'<span class="important_message">Please <a href="/logout">Login as a different user</a> to proceed</span>',{html:!0})},model={tokenPayload:function(e){return e?KJUR.jws.JWS.readSafeJSONString(b64utoutf8(e.split(".")[1])):{}}},replaceWithProfile=function(e){history.replaceState(e,"profile","/profile?"+serializeUrlParams(e)),runProfile(e)},pushProfile=function(e){history.pushState(e,"profile","/profile?"+serializeUrlParams(e)),runProfile(e)},runProfile=function(e){var n,t,i,r,a;$("body")[0].className="profile";var o=function(e){var n=function(n,t){"Profile not found"===t&&(t="The user "+(e.email||e.id)+" has not set up an OpenReview profile yet"),promptError(t,{hideErrorLabel:!0}),controller.removeHandler("profile"),replaceWithHome()},t=controller.get("/user/profile",e,null,n,!0),i=controller.get("/user/profileOptions",{},null,n,!0);return $.when(t,i)},s=function(n){if(document.title=n.preferredName+" | OpenReview",t?OpenBanner.hide():OpenBanner.hide().then(function(){var e;e=i?'<span class="important_message profile-flash-message">Currently showing your profile in Edit mode. To switch to View mode click here: <a class="btn btn-xs btn-primary toggle-profile-mode">View Profile</a></span>':'<span class="important_message profile-flash-message">Currently showing your profile in View mode. To switch to Edit mode click here: <a class="btn btn-xs btn-primary toggle-profile-mode">Edit Profile</a></span>',r?(r=!1,setTimeout(function(){generalPrompt("info",e,{html:!0,noTimeout:!0})},8250)):$("#flash-message-container").slideUp("normal",function(){generalPrompt("info",e,{html:!0,noTimeout:!0})})}),t&&_.get(e,"email")&&history.replaceState(e,"profile","/profile?id="+n.id),i){$("#content").addClass("legacy-styles");var o=buildProfileController(n,{buttonText:"Save Profile Changes",prefixedPositions:n.options.prefixedPositions,prefixedRelations:n.options.prefixedRelations,institutions:n.options.institutions},function(e){controller.post("/user/profile",e,null,function(e,n){promptError(n)},!0).then(function(){r=!0,c(),promptMessage("Your profile information has successfully been updated")})},function(){c()});a.empty().append("<header><h1>Edit Profile</h1></header>",o.view)}else{$("#content").removeClass("legacy-styles"),n.publicProfile=t;var s=Handlebars.templates.userProfile(n);a.html(s),l(n.id).then(d(n.names)).then(p)}$('#content [data-toggle="tooltip"]').tooltip({container:"body"})},l=function(e){return controller.get("/notes/search",{limit:8,offset:0,term:e,content:"authors",group:"all",source:"forum"},null,function(e,n){$("section.publications div",a).empty().append('<p class="warning">Could not load recent publications. '+n+"</p>")},!0)},d=function(e){return function(n){var t=e.map(function(e){return[e.first,e.middle,e.last].filter(function(e){return!!e}).join(" ")}),i=[],r=[],a={},o={};_.forEach(n.notes,function(e){var n=e.content.authors.map(function(e){return e.replace(/\*|\d$/g,"")});if(i=i.concat(n),_.isArray(e.content.authorids)&&e.content.authorids.length)for(var t=0;t<n.length;t++){var s=e.content.authorids[t];s&&(a[n[t]]=s,o.hasOwnProperty(s)&&o[s]!==n[t]?r.push(n[t]):o[s]=n[t])}});var s=t.concat(r),l=_.uniq(_.difference(i,s)).sort().map(function(e){return{name:e,email:_.get(a,e,null)}});return{notes:n.notes,coauthors:l}}},p=function(e){var n=Handlebars.templates["partials/noteList"]({notes:e.notes,options:{pdfLink:!1,emptyMessage:"No recent publications"}});$("section.publications div",a).html(n),e.notes.length&&$("section.publications .actions").show();var t=Handlebars.templates["partials/profileCoauthors"]({coauthors:e.coauthors});$("section.coauthors div",a).html(t)},c=function(){var e={mode:(i=!i)?"edit":"view"};history.pushState(e,"profile","/profile?"+serializeUrlParams(e)),o().then(formatProfileData).then(s)},u=function(){$("#flash-message-container").on("click","a.toggle-profile-mode",c),$("#content").on("click","a.suggest",function(){$("#profile-suggestion-modal").modal()})};controller.addHandler("profile",{token:function(r){var l=model.tokenPayload(r);_.has(l,"user.id")&!_.startsWith(l.user.id,"guest_")&&(n=l.user),a=$('<div class="profile-controller"></div>');var d,p=!_.isEmpty(e)&&(e.id||e.email),c=n&&p&&(_.includes(n.profile.usernames,e.id)||_.includes(n.profile.allEmails,e.email)),f=n&&"edit"===_.get(e,"mode");if(!p||n&&c){if(!p&&!n)return controller.removeHandler("profile"),void replaceWithLogin(function(){pushProfile()});t=!1,d={};var m="";(i=f)&&(m="?mode=edit"),!p&&i?history.replaceState(e,"profile","/profile"+m):c&&history.replaceState(e,"profile","/profile"+m)}else t=!0,d=_.pick(e,["id","email"]),a.addClass("profile-public");$("#content").empty().append(a),o(d).then(formatProfileData).then(s),u()}})},formatProfileData=function(e,n){e.hasOwnProperty("profile")&&(e=e.profile);var t=_.find(e.content.names,["preferred",!0])||_.first(e.content.names),i=[t.first,t.middle,t.last].filter(function(e){return!!e}).join(" "),r=e.content.preferred_email,a=_.has(e,"content.history[0].institution")?e.content.history[0].institution.name:null;return e.content.emails=e.content.emails.map(function(n){return{email:n,confirmed:_.includes(e.content.emailsConfirmed,n),preferred:n===r}}),delete e.content.emailsConfirmed,delete e.content.preferred_email,_.assign(e.content,{id:e.id,preferredName:i,preferredEmail:r,currentInstitution:a,options:n})},buildProfileController=function(e,n,t,i){var r=function(e){var n=["Male","Female","Unspecified"],t=function(e,n){return _.filter(e,function(e){return _.startsWith(e.toLowerCase(),n.toLowerCase())})},i=view.mkDropdown("Choose a gender or type a custom gender",!1,e,function(e,i){e(t(n,i))},function(e){});return i.find("input").addClass("gender"),$("<tr>",{border:0,class:"info_row"}).append($("<td>",{class:"info_item"}).append(i))},a=function(e,n,t,i,r){var a=$("<input>",{type:"email",class:"form-control email profile",value:n||"",readonly:t}),o=$('<button class="btn confirm_button">Confirm</button>').click(function(n){if(e){var t=a.val().toLowerCase(),i={alternate:t,username:e};controller.post("/user/confirm",i,function(){promptMessage("A confirmation email has been sent to "+t)})}else promptError("You need to save your profile before confirming a new email")}),s=$("<td>",{class:"confirm_cell"}).append($("<div>",{text:"(Confirmed)",class:"confirmed hint"}),o),l=$("<td>",{class:"preferred_cell"}).append($("<div>",{text:"(Preferred Email)",class:"preferred hint"}),$('<button class="btn preferred_button">Make Preferred</button>').click(r)),d=$("<td>").append($('<button class="btn">Remove</button>').click(function(){$(this).closest("tr").remove()})),p=$("<tr>",{border:0,class:"info_row"}).append($("<td>",{class:"info_item"}).append(a.keyup(function(){var e=$(this).val().trim();_.isEmpty(e)?(s.find(".confirmed").hide(),s.find(".confirm_button").hide(),d.hide()):(s.find(".confirmed").hide(),s.find(".confirm_button").show(),d.show())})),s,d);return t?(s.find(".confirmed").show(),s.find(".confirm_button").hide(),d.hide(),p.append(l)):n?(s.find(".confirmed").hide(),s.find(".confirm_button").show(),d.show()):(s.find(".confirmed").hide(),s.find(".confirm_button").hide(),d.hide()),i?(l.find(".preferred").show(),l.find(".preferred_button").hide()):t?(l.find(".preferred").hide(),l.find(".preferred_button").show()):(l.find(".preferred").hide(),l.find(".preferred_button").hide()),p},o=function(){return $("<tr>",{border:0}).append($("<td>",{class:"info_item"}).append($("<div>",{text:"Position",class:"small_heading row_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{text:"Start",class:"small_heading row_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{text:"End",class:"small_heading row_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{class:"row_heading"}).append($("<div>",{text:"Institution Domain",class:"item small_heading"}))),$("<td>",{class:"info_item"}).append($("<div>",{class:"row_heading"}).append($("<div>",{text:"Institution Name",class:"item small_heading"}))),$("<td>",{class:"info_item"}).append())},s=function(e,n,t,i){var r=function(e,n){return _.filter(e,function(e){return _.startsWith(e.toLowerCase(),n.toLowerCase())})},a=view.mkDropdown("Choose a position or type a new one",!1,e&&e.position,function(e,t){e(r(n,t))},function(e){_.isEmpty(e)||(n=_.union(n,[e]))});a.find("input").addClass("position");var o=view.mkDropdown("Choose a domain or type a new one",!1,e&&e.institution&&e.institution.domain,function(e,n){e(r(t,n))},function(e){_.isEmpty(e)||(t=_.union(t,[e])),l(e)});o.find("input").addClass("institution_domain");var s=$("<tr>",{border:0,class:"info_row"}).append($("<td>",{class:"info_item"}).append(a),$("<td>",{class:"info_item"}).append($("<input>",{type:"text",class:"form-control start",value:e&&e.start||"",placeholder:"year"}).keypress(v)),$("<td>",{class:"info_item"}).append($("<input>",{type:"text",class:"form-control end",value:e&&e.end||"",placeholder:"year"}).keypress(v)),$("<td>",{class:"info_item"}).append(o),$("<td>",{class:"info_item"}).append($("<input>",{type:"text",class:"form-control institution_name",value:e&&e.institution&&e.institution.name||""})),$("<td>",{class:"info_item"}).append($("<div>",{class:"glyphicon glyphicon-minus-sign"}).click(function(e){s.remove()}))),l=function(e){var n=function(e){return _.find(i,function(n){return n.id.toLowerCase()===e.toLowerCase()})},t=s.find(".institution_name");if(e){var r=n(e);if(r){var a=r.fullname,o=r.parent?n(r.parent):null;o&&o.fullname&&(a=a+", "+o.fullname),t.val(a)}else t.val("")}};return s},l=function(){return $("<tr>",{border:0}).append($("<td>",{class:"info_item"}).append($("<div>",{text:"Name",class:"small_heading row_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{text:"Email",class:"small_heading row_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{text:"Relation",class:"small_heading row_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{text:"Start",class:"small_heading row_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{text:"End",class:"small_heading row_heading"})))},d=function(e,n){var t=function(e,n){return _.filter(e,function(e){return _.startsWith(e.toLowerCase(),n.toLowerCase())})},i=view.mkDropdown("Choose a relation or type a new one",!1,e&&e.relation,function(e,i){e(t(n,i))},function(e){_.isEmpty(e)||(n=_.union(n,[e]))});i.find("input").attr({class:"form-control relation"});var r=$("<tr>",{border:0,class:"info_row"}).append($("<td>",{class:"info_item"}).append($("<input>",{type:"text",class:"form-control relation_name",value:e&&e.name||""})),$("<td>",{class:"info_item"}).append($("<input>",{type:"text",class:"form-control relation_email",value:e&&e.email||""})),$("<td>",{class:"info_item"}).append(i),$("<td>",{class:"info_item"}).append($("<input>",{type:"text",class:"form-control relation_start",value:e&&e.start||"",placeholder:"year"}).keypress(v)),$("<td>",{class:"info_item"}).append($("<input>",{type:"text",class:"form-control relation_end",value:e&&e.end||"",placeholder:"year"}).keypress(v)),$("<td>",{class:"info_item"}).append($("<div>",{class:"glyphicon glyphicon-minus-sign "}).click(function(e){r.remove()})));return r},p=function(){return $("<tr>",{border:0,class:""}).append($("<td>",{class:"info_item"}).append($("<div>",{class:"row_heading"}).append($("<div>",{text:"Research areas of interest",class:"item small_heading"}))),$("<td>",{class:"info_item"}).append($("<div>",{text:"Start",class:"small_heading row_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{text:"End",class:"small_heading row_heading"})))},c=function(e,n,t){var i=$("<tr>",{border:0,class:"info_row"}).append($("<td>",{class:"info_item"}).append($("<input>",{type:"text",class:"form-control expertise",value:e||""})),$("<td>",{class:"info_item"}).append($("<input>",{type:"text",class:"form-control start",value:n||"",placeholder:"year"}).keypress(v)),$("<td>",{class:"info_item"}).append($("<input>",{type:"text",class:"form-control end",value:t||"",placeholder:"year"}).keypress(v)),$("<td>",{class:"info_item"}).append($("<div>",{class:"glyphicon glyphicon-minus-sign "}).click(function(e){i.remove()})));return i},u=function(){return $("<tr>",{border:0,class:""}).append($("<td>",{class:"info_item"}).append($("<div>",{text:"First",class:"small_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{text:"Middle (optional)",class:"small_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{text:"Last",class:"small_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{text:"",class:"small_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{text:"",class:"small_heading"})))},f=function(e,n,t,i,r,a){var o=!_.isEmpty(i),s=$("<td>",{class:"preferred_cell"}).append($("<div>",{text:"(Preferred Name)",class:"preferred hint"}),$('<button class="btn preferred_button">Make Preferred</button>').click(a)),l=function(e){return function(){var n=e.find(".first_name").val(),t=e.find(".middle_name").val(),i=e.find(".last_name").val();controller.get("tildeusername",{first:n,last:i,middle:t},function(r){var a=r.username;n===e.find(".first_name").val()&&t===e.find(".middle_name").val()&&i===e.find(".last_name").val()&&e.find(".newUsername").text(a)},null,!0)}},d=$("<tr>",{border:0,class:"info_row"}).append($("<td>",{class:"info_item"}).append($("<input>",{type:"text",class:"form-control first_name profile",value:e||"",readonly:o})),$("<td>",{class:"info_item"}).append($("<input>",{type:"text",class:"form-control middle_name profile",value:n||"",readonly:o})),$("<td>",{class:"info_item"}).append($("<input>",{type:"text",class:"form-control last_name profile",value:t||"",readonly:o})),$("<td>",{class:"info_item"}).append($("<span>",{class:"newUsername"}).text(i)),$("<td>",{class:"info_item"}).append($("<span>",{class:"username"}).text(i).hide()),$("<td>",{class:"info_item"}).append(s));return r?(s.find(".preferred").show(),s.find(".preferred_button").hide()):(s.find(".preferred").hide(),s.find(".preferred_button").show()),d.find(".first_name").keyup(l(d)),d.find(".middle_name").keyup(l(d)),d.find(".last_name").keyup(l(d)),d},m=function(e,n){var t=function(e,n){return e||n?e?n?n-e:1:-1:1};if(!e.end&&!n.end)return t(e.start,n.start);if(!e.end)return-1;if(!n.end)return 1;var i=n.end-e.end;return 0===i?t(e.start,n.start):i},v=function(e){if(String.fromCharCode(e.keyCode).match(/[^0-9]/g))return!1},h=function(e,n,t,i,m){var v=$("<table>",{id:"names_table",class:"info_table"}).append(u()),h=function(e){v.find(".preferred").hide(),v.find(".preferred_button").show();var n=$(e.target).parent();n.find(".preferred").show(),n.find(".preferred_button").hide()},g=e.names;g&&g.length?v.append(_.flatten(_.map(g,function(e){return[f(e.first,e.middle,e.last,e.username,e.preferred,h)]}))):v.append(f("","","","",!0,h));var y=$("<div>",{class:"glyphicon glyphicon-plus-sign"}).click(function(){v.append(f("","","","",!1,h))}),b=$("<table>",{id:"personal_table",class:"info_table"}).append(r(e.gender)),w=$("<table>",{id:"emails_table",class:"info_table"}),k=function(e){w.find(".preferred").hide(),w.find(".preferred_button").show();var n=$(e.target).parent();n.find(".preferred").show(),n.find(".preferred_button").hide()},x=e.emails;e.emailsConfirmed,e.preferred_email;x&&x.length?w.append(_.flatten(_.map(x,function(n){return[a(e.id,n.email,n.confirmed,n.preferred,k)]}))):w.append(a(e.id,"",!1,!1,k),a(e.id,"",!1,!1,k),a(e.id,"",!1,!1,k));var C=$("<div>",{class:"glyphicon glyphicon-plus-sign "}).click(function(){w.append(a(e.id,"",!1,!1,k))}),E=$("<table>",{id:"history_table",class:"info_table"}).append(o()),S=e.history;S&&S.length?E.append(_.flatten(_.map(S,function(e){return[s(e,n,t,i)]}))):E.append(s({},n,t,i),s({},n,t,i),s({},n,t,i));var H=$("<div>",{class:"glyphicon glyphicon-plus-sign "}).click(function(){E.append(s({},n,t,i))}),R=$("<table>",{id:"relation_table",class:"info_table"}).append(l()),N=e.relations;N&&N.length?R.append(_.flatten(_.map(N,function(e){return[d(e,m)]}))):R.append(d({},m),d({},m),d({},m));var I=$("<div>",{class:"glyphicon glyphicon-plus-sign "}).click(function(){R.append(d({},m))}),O=$("<table>",{id:"url1_table",class:"info_table"}).append($("<tr>",{border:0,class:""}).append($("<td>",{class:"info_item"}).append($("<div>",{text:"Homepage URL",class:"small_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{text:"Google Scholar URL",class:"small_heading"}))),$("<tr>",{border:0,class:"info_row"}).append($("<td>",{class:"info_item"}).append($("<input>",{class:"form-control",type:"text",id:"homepage_url",value:e.homepage||""})),$("<td>",{class:"info_item"}).append($("<input>",{class:"form-control",type:"text",id:"gscholar_url",value:e.gscholar||""})))),P=$("<table>",{id:"url2_table",class:"info_table"}).append($("<tr>",{border:0,class:""}).append($("<td>",{class:"info_item"}).append($("<div>",{text:"DBLP URL",class:"small_heading"})),$("<td>",{class:"info_item"}).append($("<div>",{text:"Linkedin URL",class:"small_heading"}))),$("<tr>",{border:0,class:"info_row"}).append($("<td>",{class:"info_item"}).append($("<input>",{class:"form-control",type:"text",id:"dblp_url",value:e.dblp||""})),$("<td>",{class:"info_item"}).append($("<input>",{class:"form-control",type:"text",id:"linkedin_url",value:e.linkedin||""})))),T=$("<table>",{id:"url3_table",class:"info_table"}).append($("<tr>",{border:0,class:""}).append($("<td>",{class:"info_item"}).append($("<div>",{text:"Wikipedia URL",class:"small_heading"}))),$("<tr>",{border:0,class:"info_row"}).append($("<td>",{class:"info_item"}).append($("<input>",{class:"form-control",type:"text",id:"wikipedia_url",value:e.wikipedia||""})))),L=$("<table>",{id:"expertise_table",class:"info_table"}).append(p()),D=e.expertise;D&&D.length?L.append(_.flatten(_.map(D,function(e){return[c(e.keywords.join(", "),e.start,e.end)]}))):L.append(c(),c(),c());var M=$("<div>",{class:"glyphicon glyphicon-plus-sign "}).click(function(){L.append(c())});return[$("<section>").append("<h4>Names</h4>",'<p class="instructions">How do you usually write your name as author of a paper? Also add any other names you have authored papers under.</p>',v,y),$("<section>").append("<h4>Gender</h4>",'<p class="instructions">This information helps conferences better understand their gender diversity. (Optional)</p>',b),$("<section>").append("<h4>Emails</h4>",'<p class="instructions">Enter email addresses associated with all of your current and historical institutional affiliations, as well as all your previous publications, and the Toronto Paper Matching System. This information is crucial for deduplicating users, and ensuring you see your reviewing assignments.</p>',w,C),$("<section>").append("<h4>Personal Links</h4>",'<p class="instructions">Add links to your profiles on other sites. (Optional)</p>',O,P,T),$("<section>").append("<h4>Education &amp; Career History</h4>",'<p class="instructions">Enter your education and career history. The institution domain is used for conflict of interest detection and institution ranking. For ongoing positions, leave the end field blank.</p>',E,H),$("<section>").append("<h4>Advisors &amp; Other Relations</h4>",'<p class="instructions">Enter all advisors, co-workers, and other people that should be included when detecting conflicts of interest.</p>',R,I),$("<section>").append("<h4>Expertise</h4>",'<p class="instructions">For each line, enter comma-separated keyphrases representing an intersection of your interests. Think of each line as a query for papers in which you would have expertise and interest. For example:<br><em>topic models, social network analysis, computational social science</em><br><em>deep learning, RNNs, dependency parsing</em></p>',L,M)]};return function(e,n,t){var r=n.prefixedPositions,a=n.prefixedRelations,o=n.institutions,s=o.map(function(e){return e.id}).filter(function(e){return!_.isEmpty(e)}),l=n.buttonText,d=function(){var e=[];return $("#names_table").find(".info_row").each(function(n){var t=$(this),i=t.find(".first_name").val(),r=t.find(".middle_name").val().trim(),a=t.find(".last_name").val().trim(),o=t.find(".username").text().trim(),s=t.find(".preferred").is(":visible");i&&a&&e.push({first:i,middle:r,last:a,username:o,preferred:s})}),e},p=function(){var e=[],n="";return $("#emails_table").find(".info_row").each(function(t){var i=$(this),r=i.find(".email").val().trim(),a=i.find(".preferred").is(":visible");if(r){var o=r.toLowerCase();e.push(o),a&&(n=o)}}),[e,n]},c=function(){var e=[];return $("#history_table").find(".info_row").each(function(n){var t=$(this),i=t.find(".position").val().trim(),r=t.find(".institution_name").val().trim(),a=t.find(".institution_domain").val().trim();i&&a&&e.push({position:i,start:Number(t.find(".start").val().trim())||null,end:Number(t.find(".end").val().trim())||null,institution:{domain:a&&a.toLowerCase(),name:r}})}),e.sort(m)},u=function(){var e=[];return $("#relation_table").find(".info_row").each(function(n){var t=$(this),i=t.find(".relation").val().trim();i&&e.push({name:t.find(".relation_name").val().trim()||null,email:t.find(".relation_email").val().trim().toLowerCase()||null,relation:i,start:Number(t.find(".relation_start").val().trim())||null,end:Number(t.find(".relation_end").val().trim())||null})}),e.sort(m)},f=function(){var e=[];return $("#expertise_table").find(".info_row").each(function(n){var t=$(this),i=t.find(".expertise").val().trim();i&&e.push({keywords:i.split(",").map(function(e){return e.trim()}),start:Number(t.find(".start").val().trim())||null,end:Number(t.find(".end").val().trim())||null})}),e.sort(m)},v=function(){return $("#personal_table").find(".gender").val().trim()},g=function(){var e=d(),n=v(),t=c(),i=u(),r=f(),a=p(),o=$("#url1_table"),s=$("#url2_table"),l=$("#url3_table");return{active:!0,names:e,gender:n,homepage:o.find("#homepage_url").val(),gscholar:o.find("#gscholar_url").val(),dblp:s.find("#dblp_url").val(),linkedin:s.find("#linkedin_url").val(),wikipedia:l.find("#wikipedia_url").val(),emails:a[0],preferred_email:a[1],history:t,relations:i,expertise:r}},y=function(){var e=function(e,n){for(var t=!0,i=0;i<e.length;i++){var r,a=e[i];if(a.start&&a.end&&a.start>a.end){promptError("End date should be higher than start date"),r=$("tr",n),$(r[i+1]).find(".end").addClass("invalid_value"),t=!1;break}if(!a.start&&a.end){promptError("Start date can not be empty"),r=$("tr",n),$(r[i+1]).find(".start").addClass("invalid_value"),t=!1;break}}return t},n=g();if(function(e){var n=$("#names_table");if(_.isEmpty(e)){promptError("Enter first and last name");var t=$("tr",n),i=$(t[1]);return i.find(".first_name").addClass("invalid_value"),i.find(".last_name").addClass("invalid_value"),!1}return!0}(n.names)){var t=$("#history_table");if(e(n.history,t)&&function(e,n){if(_.isEmpty(e)){promptError("You must enter position and institution domain information sufficient to capture your conflict of interest");var t=$("tr",n),i=$(t[1]);return i.find(".position").addClass("invalid_value"),i.find(".institution_domain").addClass("invalid_value"),!1}return!0}(n.history,t)){var i=$("#expertise_table");if(e(n.expertise,i))return n}}return!1},b=$("<div>",{class:"profile-edit-container"}),w=h(e,r,s,o,a),k=$('<button class="btn">'+l+"</button>").click(function(){var n=y();if(n){var i=_.assign(e,{content:n});t(i)}}),x=$('<button class="btn">Cancel</button>').click(function(){var n=h(e,r,s,o);b.empty().append(n),w=n,i&&i()});return b.append(w),b.append(k,x),{view:b,canExit:function(){var t=g(),i=!_.isEqual(_.omit(e.content,["password","emailsConfirmed"]),t);return n.activation&&i?(promptError("You must save your profile changes to active your account"),!1):!i||(promptError("You must first save or cancel your profile changes"),!1)}}}(e,n,t)},replaceWithReset=function(e){history.replaceState({},"reset","/reset?"+serializeUrlParams({token:e})),runReset(e)},pushReset=function(e){history.pushState({},"reset","/reset?"+serializeUrlParams({token:e})),runReset(e)},runReset=function(e){var n=$("#content").empty();controller.get("resettable/"+e,{},function(t){var i=t.resettable,r=(i.groupId,i.group,$("<div>",{class:"row reset-container"}).append($("<div>",{text:"Password",class:"small_heading"}),$("<input>",{class:"form-control",type:"password",id:"password"}))),a=$('<button class="btn row">Set Password</button>').click(function(){var n={password:r?r.find("#password").val():null};controller.put("reset/"+e,n,function(e){var n=e.token;controller.update("token",n),replaceWithHome()})}),o=$("<h1>").text("Reset password"),s=$("<div>",{class:"panel"}).append(r,a);n.append($("<div>",{class:"panel"}).append(o,s))})},replaceWithResetConfirm=function(e){history.replaceState({email:e},"resetConfirm","/resetConfirm"),runResetConfirm(e)},pushResetConfirm=function(e){history.pushState({email:e},"resetConfirm","/resetConfirm"),runResetConfirm(e)},runResetConfirm=function(e){var n=$("#content"),t={token:function(t){var i=model.tokenPayload(t);if(n.empty(),i.user&&i.user.profile){var r=i.user.profile,a=Handlebars.templates.userMenu({user:r});$("#user-menu").remove(),$("#navbar ul.navbar-nav").append(a),controller.removeHandler("resetConfirm"),pushTasks()}else{var o=$("<h1>").text("Password reset in progress: Check your inbox"),s=$("<div>",{class:"panel"}).append($("<div>",{class:"row"}).append($("<span>",{class:"important_message"}).text("Email was sent to "),$("<span>",{class:"important_term"}).text(e),$("<span>",{class:"important_message"}).text(" with subject “OpenReview password reset”.\n"),$("<span>",{class:"important_message"}).text("Please click on the link in this email to reset your password.")));n.append($("<div>",{class:"panel"}).append(o,s))}}};controller.addHandler("resetConfirm",t)},replaceWithRevisions=function(e){history.replaceState({},"revisions","/revisions"),runRevisions(e)},pushRevisions=function(e,n,t){var i={id:e,left:n,right:t};history.pushState(i,"revisions","/revisions?"+serializeUrlParams(i)),runRevisions(e,n,t)},runRevisions=function(e,n,t){var i=!0;e||replaceWithHome();var r=function(e){var n=e.invitation.split("/-/")[0],t={link:"/group?id="+n,text:view.prettyId(n)};e.content.venue&&(t={text:e.content.venue}),OpenBanner.breadcrumbs([{link:"/",text:"Venues"},t,{link:"/forum?id="+e.id,text:view.truncateTitle(e.content.title)}])},a=function(e){var n=$("#content").empty(),t=i?"guest-user-view":"";n.append(['<div class="revisions-container '+t+'">','<div id="header" class="clearfix">',"<h1>Revision History</h1>",'<div class="button-container">','<button type="button" class="btn btn-primary btn-compare">Compare Revisions</button>','<button type="button" class="btn btn-primary btn-view disabled" style="display: none;">View Differences</button>','<button type="button" class="btn btn-default btn-cancel" style="display: none;">Cancel</button>',"</div>","</div>",'<div class="references-list hide-sidebar"></div>',"</div>"].join("\n"));var r;e.length?(r=e.map(function(e){return $("<div>",{class:"row"}).append($("<div>",{class:"checkbox col-sm-1"}).append('<label><input type="checkbox"></label>'),view.mkNotePanel(e,{withContent:!0,withReplyCount:!1,withRevisionsLink:!1,isReference:!0,withModificationDate:!0,withDateTime:!0}).removeClass("panel").addClass("col-sm-11")).data("id",e.id)})).unshift($('<div class="alert alert-warning">To view a full comparison select two revisions by checking the corresponding checkboxes, then click the View Differences button.</div>')):r=[$('<div class="alert alert-danger">No revisions to display.</div>')],$(".references-list").append(r),o()},o=function(){$("#header .btn-compare").on("click",function(){i?promptLogin():($(".references-list").removeClass("hide-sidebar"),$(this).hide(),$("#header .btn-view").show(),$("#header .btn-cancel").show())}),$("#header .btn-view").on("click",function(){if($(this).hasClass("disabled"))return!1;var n=$('.references-list input[type="checkbox"]:checked'),t=n.eq(1).closest(".row").data("id"),i=n.eq(0).closest(".row").data("id");$(".revisions-container").html(Handlebars.templates.spinner()),pushRevisions(e,t,i)}),$("#header .btn-cancel").on("click",function(){$(".references-list").addClass("hide-sidebar"),$("#header .btn-compare").show(),$("#header .btn-view").hide(),$(this).hide(),$('.references-list input[type="checkbox"]').each(function(){$(this).prop("checked",!1)})}),$(".references-list .note .title_pdf_row").on("click",function(){$(this).closest(".row").find('input[type="checkbox"]').click()}),$('.references-list input[type="checkbox"]').on("change",function(){2===$('.references-list input[type="checkbox"]:checked').length?$("#header .btn-view").removeClass("disabled"):$("#header .btn-view").addClass("disabled")})},s=function(n){var t=n.leftNote.content,i=n.rightNote.content,r=_.reduce(t,function(e,n,t){return _.isEqual(n,i[t])||_.includes(["pdf","verdict","paperhash","_dblp","_bibtex"],t)||(e[t]={left:n,right:i[t]}),e},{}),a=Handlebars.templates.noteComparison(_.assign({},n,{contentDiff:_.isEmpty(r)?null:r}));$("#content").html(a),$("#header .btn-back").on("click",function(){pushRevisions(e)})};controller.addHandler("references",{token:function(o){var l=model.tokenPayload(o),d=(controller.get("/notes",{id:e},null,function(){},!0).then(function(e){e.notes.length?r(e.notes[0]):OpenBanner.hide()}),function(){return controller.get("/references",{referent:e,original:!0}).then(function(e){return e.references}).then(a)});l.user&&l.user.id&&!_.startsWith(l.user.id,"guest_")?(i=!1,n&&t?controller.get("/pdf/compare",{noteId:e,leftId:n,rightId:t},null,function(){},!0).then(s).fail(function(e,n,t){$(".revisions-container .spinner-container").remove(),$(".revisions-container").append('<div class="alert alert-danger">Unabled to load comparison viewer at this time. Please try again later.</div>')}):d()):d()}})},tokenize=function(e){return e.toLowerCase().replace(/'\"/g,"").replace(/\W/g," ").replace(/\s\s+/g," ").split(" ")},truncate=function(e,n){var t,i=new RegExp(n+".*","i"),r=e.match(i);if(r&&r.index&&e.length>85){for(var a=e.split(n)[0],o=e.split(n)[1],s=a.split(" "),l=1===s.length?"":"&hellip;",d=l+s[s.length-1],p=o.slice(0,85-(n.length-"<b></b>".length)-d.length),c=s.length-2;(d+n+p).length<85;)d=l+s.slice(c,s.length-1).join(" ")+" ",c-=1;t=d+n+p}else t=e;return t},emphasize=function(e,n){var t,i=new RegExp(n+".*","i"),r=e.match(i),a=r?"<b>"+r.input.slice(r.index,r.index+n.length)+"</b>":"<b>"+n+"</b>";return t=r&&void 0!==r.index?e.slice(0,r.index)+a+e.slice(r.index+n.length,e.length):e,truncate(t,a)},getTokenObjects=function(e,n){var t=_.map(e,function(e){return e.content}),i=new RegExp(n+".*","i"),r=_.uniq(_.filter(_.flattenDeep(_.map(t,function(e){return _.without(_.map(e,function(e){return _.isArray(e)?e:"string"==typeof e?tokenize(e):null}),null)})),function(e){try{return e.match(i)}catch(e){return!1}}));return _.map(r,function(e){return{value:e,label:emphasize(e,n),section:"tokens"}})},contentToString=function(e){return _.isArray(e)?e.join(", "):_.isString(e)?e:""},getTitleObjects=function(e,n){var t=new RegExp(n+".*","i");return _.filter(_.map(e,function(e){var t=e.content;return{value:_.isEmpty(t.title)?"":t.title,forum:_.has(e,"forum")?e.forum:"",id:e.id,label:_.isEmpty(t.title)?"":emphasize(t.title,n),subtitle:_.isEmpty(t.authors)?"":emphasize(contentToString(t.authors),n),authors:_.isEmpty(t.authors)?"":t.authors,section:"titles"}}),function(e){return!_.isEmpty(e.value)&&e.value.match(t)||!_.isEmpty(e.authors)&&contentToString(e.authors).match(t)})},runAutocomplete=function(e){e.autocomplete_mod({source:function(e,n){e.term.length>2?controller.get("notes/search",{term:e.term,content:$("#search_content").val()||"all",group:$("#search_group").val()||"all",source:$('input[name="source"]:checked').val()||"all",limit:10},function(t){var i=getTokenObjects(t.notes,e.term),r=getTitleObjects(t.notes,e.term);n([].concat(i,r))},function(n){promptError('There was an error while searching for "'+e.term+'".')}):n([])},minLength:2,select:function(n,t){if(e.val(t.item.value),"titles"===t.item.section)window.legacyScripts?pushForum(t.item.forum,t.item.id):window.location.href="/forum?"+$.param({id:t.item.forum,noteId:t.item.id});else{var i={term:t.item.value,content:$("#search_content").val()||"all",group:$("#search_group").val()||"all",source:$('input[name="source"]:checked').val()||"all"};window.legacyScripts?pushSearchResults(i):window.location.href="/search?"+$.param(i)}},appendTo:$("form")}),e.keyup(function(e){13===e.which&&$(".ui-menu").hide()})},pushSearchResults=function(e){if(!e.term)return promptError("Missing search term"),!1;history.pushState({},"search","/search?"+serializeUrlParams(e)),runSearchResults(e)},runSearchResults=function(e){$("body")[0].className="search",$("#content").addClass("legacy-styles"),OpenBanner.hide(),$("#flash-message-container").find(".profile-flash-message").length&&$("#flash-message-container").slideUp(),$("#content").html(Handlebars.templates.spinner());var n=$("#search_input"),t=$("#search_group"),i=$("#search_content");n.val(e.term),t.val(e.group),i.val(e.content);var r,a=function(){e={term:n.val(),content:i.val(),group:t.val(),source:$('input[name="source"]:checked').val()},history.pushState({},"search","/search?"+serializeUrlParams(e))},o=function(n){n=n||0;var t=_.assign({limit:100,offset:n},e);return controller.get("notes/search",t).then(function(e){return e})},s=function(){return controller.get("groups",{id:"host"}).then(function(e){var n=[{id:"all",description:"all of OpenReview"}];return _.forEach(e.groups[0].members,function(e){n.push({id:e,description:view.prettyId(e)})}),n})},l=function(r){var s=$("<form>",{id:"search_options",class:"form-inline"}),l=t.val(),p=_.find(r,["id",l]);p||(p={id:l,description:view.prettyId(l)},r.push(p));var c="all"===p.id?"Search OpenReview":"Search "+p.description;n.attr("placeholder",c);var u=[{id:"all",description:"All Content"},{id:"authors",description:"Authors"},{id:"tags",description:"Tags"},{id:"keywords",description:"Keywords"}],f=view.mkDropdown("Choose a document type to search over",!0,_.find(u,["id",i.val()]),function(e,n){e(u)},function(e,n){i.val(n),a(),o().then(d)},"doc-type"),m=view.mkDropdown("Choose a conference to search over",!0,p,function(e,n){e(r)},function(e,i){var r="all"===i?"Search OpenReview":"Search "+e;t.val(i),n.attr("placeholder",r),a(),o().then(d)},"conference-name"),v="all"===e.source?'checked="checked"':"",h="forum"===e.source?'checked="checked"':"",g="reply"===e.source?'checked="checked"':"";s.append($('<div class="form-group">').append('<label class="adjust">Search over</label>',f),$('<div class="form-group">').append('<label class="adjust">in</label>',m),$('<div class="form-group source-group">').append('<label class="radio-inline"><input type="radio" name="source" value="all" '+v+"> All</label>",'<label class="radio-inline"><input type="radio" name="source" value="forum" '+h+"> Papers only</label>",'<label class="radio-inline"><input type="radio" name="source" value="reply" '+g+"> Replies only</label>"));s.find('input[name="source"]').on("click",function(){e.source!==$(this).val()&&(a(),o().then(d))}),$("#content").empty().append(s,$("<div>",{class:"search-results"}))},d=function(n){var t=n.notes,i=$("#content > .search-results");i.empty();var a=(n.count||(t?t.length:0))+' results found for "'+e.term+'"';if(a+="all"===e.group?"":" in "+view.prettyId(e.group),i.append("<h4>"+a+"</h4>","<hr>",Handlebars.templates.spinner({extraClasses:"spinner-inline"})),_.isEmpty(t))i.find(".spinner-container").remove();else{var o=$("<div>");_.forEach(t,function(e){o.append(view.mkNotePanel(e,{titleLink:"HREF",withParentNote:!0,withBibtexLink:!1,user:r}))}),i.find(".spinner-container").remove(),i.append(o),100===t.length&&p()}},p=function(){var e,n=$("#content > .search-results > div"),t=0,i=!1;$(window).off("scroll").on("scroll",_.debounce(function(){i||window.pageYOffset>$(document).height()-window.innerHeight-400&&(t+=100,i=!0,e=$(Handlebars.templates.spinner({extraClasses:"spinner-inline"})),n.append(e),o(t).then(function(t){var a=t.notes;e.remove(),_.isEmpty(a)?$(window).off("scroll"):(_.forEach(a,function(e){n.append(view.mkNotePanel(e,{titleLink:"HREF",withParentNote:!0,withBibtexLink:!1,user:r}))}),i=!1)}))},200))};controller.addHandler("search",{token:function(e){var n=model.tokenPayload(e);r=n.user||null,$.when(o(),s()).done(function(e,n){l(n),d(e)}).fail(function(e){$("#content").empty().append("<p>Enter your search term in the box above</p>")})}})},replaceWithSignup=function(){history.replaceState({},"signup","/signup"),runSignup()},pushSignup=function(){history.pushState({},"signup","/signup"),runSignup()},runSignup=function(){var e=$("#content"),n=$("<h1>").text("Sign Up"),t=$("<div>",{class:"panel signup-container"}),i=$("<div>"),r=function(e){var n=$('<button class="btn signup" disabled="disabled">').text("Sign Up").click(function(){$("#password_panel").removeClass("hidden"),n.addClass("hidden")}),r=function(){var n=$("#first_input").val().trim(),t=$("#middle_input").val().trim(),i=$("#last_input").val().trim();n&&i&&e(n,t,i),s(n,t,i)};t.empty(),t.append($("<div>",{class:"hint"}).css("margin-top",".3em").text("How do you usually write your name as author of a paper?"),$("<div>",{class:"row"}).append($("<div>",{style:"display: inline-block; margin-right: 10px;"}).append(view.mkSmallHeading("First"),$("<input>",{type:"text",id:"first_input",class:"form-control"}).keyup(r),$("<div>").append($("<span>",{class:"newUsername"}).text("required"))),$("<div>",{style:"display: inline-block; margin-right: 10px;"}).append(view.mkSmallHeading("Middle"),$("<input>",{type:"text",id:"middle_input",class:"form-control"}).keyup(r),$("<div>").append($("<span>",{class:"newUsername"}).text("optional"))),$("<div>",{style:"display: inline-block;"}).append(view.mkSmallHeading("Last name"),$("<input>",{type:"text",id:"last_input",class:"form-control"}).keyup(r),$("<div>").append($("<span>",{class:"newUsername"}).text("required")))),$("<div>",{class:"spacer"}),$("<div>",{class:"row"}).append(view.mkSmallHeading("Email")),i,$("<div>",{class:"row"}).append($("<div>",{style:"display: inline-block;"}).append($("<input>",{class:"signup form-control",type:"text",id:"email_input",placeholder:"My email"}).on("keyup change click",function(){var e=/.+@.+/,t=$("#email_input").val().trim();t.match(e)||"openreview.net"===t.toLowerCase()?n.prop({disabled:!1}):(n.removeClass("hidden"),$("#password_panel").addClass("hidden"),n.prop({disabled:!0}))})),$("<div>",{style:"display: inline-block;"}).append(n),$("<div>",{style:"display: inline-block;"}).append($("<span>",{class:"newUsername",style:"padding-left: 1em",id:"newUsername"}).text("")),$("<div>",{id:"password_panel",style:"padding-top: 0.3em",class:"hidden"}).append($("<div>",{style:"display: inline-block;"}).append($("<input>",{class:"signup form-control",type:"password",id:"password_input",placeholder:"Password"})),$("<div>",{style:"display: inline-block;"}).append($('<button class="btn signup">').text("Sign up").click(function(){var e=$("#first_input").val().trim(),n=($("#middle_input").val().trim(),$("#last_input").val().trim());if(e&&n){var t={email:$("#email_input").val().trim(),password:$("#password_input").val().trim(),name:{first:$("#first_input").val().trim(),middle:$("#middle_input").val().trim(),last:$("#last_input").val().trim()}};controller.post("register",t,function(e){controller.removeHandler("signup"),pushConfirm(e.content.preferred_email)})}else promptError("You must enter a first and last name")})))))},a=function(e,n,t){var r=function(e){var n=function(e){var n=$('<button class="btn signup">Reset Password</button>').click(function(){r.removeClass("hidden"),n.addClass("hidden")}),t=$("<input>",{class:"signup form-control",type:"text",id:"confirm_email_input",placeholder:"Enter full email for "+e}).keyup(function(){var e=/.+@.+/,n=t.val().trim();n.match(e)||"openreview.net"===n.toLowerCase()?i.prop({disabled:!1}):i.prop({disabled:!0})}),i=$('<button id="send_reset_button" class="btn signup" disabled="true">Send Password Reset</button>'),r=$("<div>",{style:"padding-top: 1em",class:"hidden"}).append($("<div>",{style:"display: inline-block;"}).append(t),$("<div>",{style:"display: inline-block;"}).append(i.click(function(){var e={id:t.val().trim()};controller.post("resettable",e,function(e){controller.removeHandler("signup"),pushResetConfirm(e.id)})})));return{button:n,panel:r}},t=function(e){var n=$('<button class="btn signup">').text("Resend Activation").click(function(){r.removeClass("hidden"),n.addClass("hidden")}),t=$("<input>",{class:"signup form-control",type:"text",placeholder:"Enter full email for "+e}).keyup(function(){var e=/.+@.+/,n=t.val().trim();n.match(e)||"openreview.net"===n.toLowerCase()?i.prop({disabled:!1}):i.prop({disabled:!0})}),i=$('<button class="btn signup" disabled="true">').text("Send Activation link").click(function(){var e={id:t.val().trim()};controller.post("activatable",e,function(e){controller.removeHandler("signup"),pushConfirm(e.id)})}),r=$("<div>",{style:"padding-top: 0.3em",class:"hidden"}).append($("<div>",{style:"display: inline-block;"}).append(t),$("<div>",{style:"display: inline-block;"}).append(i));return{button:n,panel:r}},i=function(e){var n=$('<button class="btn signup">').text("Sign up").click(function(){i.removeClass("hidden"),n.addClass("hidden")}),t=$("<input>",{class:"signup form-control",type:"password",placeholder:"Password"}),i=$("<div>",{style:"padding-top: 0.3em",class:"hidden"}).append($("<div>",{style:"display: inline-block;"}).append(t),$("<div>",{style:"display: inline-block;"}).append($('<button class="btn signup">').text("Sign up").click(function(){var n={id:e,password:t.val().trim()};controller.post("register",n,function(e){controller.removeHandler("signup"),pushConfirm(e.content.preferred_email)})})));return{button:n,panel:i}},r=function(e,r,a,o){return r?n(o):a?t(o):i(e)};return _.map(e.content.emailsConfirmed,function(n){var t=n,i=r(e.id,e.content.active,e.content.password,t);return $("<div>",{class:"row"}).append($("<div>",{style:"display: inline-block;"}).append($("<input>",{class:"profile signup form-control",type:"text",readonly:!0,value:t})),$("<div>",{style:"display: inline-block;"}).append(i.button),$("<div>",{style:"display: inline-block;"}).append($("<span>",{class:"newUsername",style:"padding-left: 1em"}).text("for "+e.id)),i.panel)})};i.empty(),_.isEmpty(e)?$("#email_input").attr("placeholder","My email"):(_.forEach(e,function(e){var n=r(e);_.forEach(n,function(e){i.append(e)})}),$("#email_input").attr("placeholder","None are me. My email"))},o=function(e,n,t,i){var r={first:e,middle:"",last:t};controller.get("/user/profile",r,function(e){a(e.profiles)})},s=function(e,n,t){var i={first:e,middle:n,last:t};controller.get("/tildeusername",i,function(e){$("#newUsername").text("for "+e.username)})},l={token:function(i){var a=model.tokenPayload(i);if(e.empty(),a.user&&a.user.profile){var s=a.user.profile,l=Handlebars.templates.userMenu({user:s});$("#user-menu").remove(),$("#navbar ul.navbar-nav").append(l),controller.removeHandler("signup"),pushTasks()}else e.append($("<div>",{class:"panel"}).append(n,t)),r(o)}};controller.addHandler("signup",l)},replaceWithTasks=function(){history.replaceState({},"tasks","/tasks"),runTasks()},pushTasks=function(){history.pushState({},"tasks","/tasks"),runTasks()},runTasks=function(){function e(e,n,t){return view.mkNotePanel(e,{titleLink:"HREF",withReplyCount:!0,withParentNote:n,userId:t&&t.id,onTrashedOrRestored:function(e){controller.get("notes",{invitee:!0,duedate:!0}).then(function(e){return e.notes}).then(function(e){c.update("invitationPairs",e)});!!e.ddate&&e.ddate<Date.now()?(c.update("trashNotes",_.flatten([c.get("trashNotes"),e])),c.update("paperNotes",_.filter(c.get("paperNotes"),function(n){return n.id!==e.id})),c.update("replyNotes",_.filter(c.get("replyNotes"),function(n){return n.id!==e.id}))):(c.update("trashNotes",_.filter(c.get("trashNotes"),function(n){return n.id!==e.id})),e.forum===e.id?c.update("paperNotes",_.flatten([c.get("paperNotes"),e])):c.update("replyNotes",_.flatten([c.get("replyNotes"),e])))}}).removeClass("panel").addClass("row")}$("body")[0].className="tasks";var n=$("#content").empty(),t=$("<h1>").text("Tasks"),i=$("<div>"),r=$("<div>"),a=$("<div>"),o=$("<div>"),s=$("<div>"),l=$("<div>"),d=$("<div>"),p=$("<div>",{class:"panel"});i.append(p,r,o,a,s,l,d,Handlebars.templates.spinner({extraClasses:"spinner-inline"})),n.append($("<div>",{class:"panel"}).append(t,i));var c=mkStateManager();controller.addHandler("tasks",{token:function(n){var t=model.tokenPayload(n);if(t.user&&t.user.id&&!_.startsWith(t.user.id,"guest_")){var o=t.user,p=controller.get("notes",{invitee:!0,duedate:!0}).then(function(e){return e.notes}),u=controller.get("notes",{tauthor:!0,trash:!0}).then(function(e){return e.notes}),f=controller.get("invitations",{invitee:!0,tags:!0}).then(function(e){return e.invitations}),m=u.then(function(e){return _.filter(e,function(e){var n=!!e.ddate&&e.ddate<Date.now();return e.forum===e.id&&!n&&e.content.pdf})}),v=u.then(function(e){return _.filter(e,function(e){var n=!!e.ddate&&e.ddate<Date.now();return e.forum&&e.forum!==e.id&&!n})}),h=u.then(function(e){return _.filter(e,function(e){return!!e.ddate&&e.ddate<Date.now()})});$.when(f,p,m,v,h).done(function(e,n,t,r,a){c.update("invitationPairs",[e,n]),c.update("paperNotes",t),c.update("replyNotes",r),c.update("trashNotes",a),i.find(".spinner-container").remove()});var g=function(e){var n=Date.now()-e.getTime();return n>0?"expired":n>-2592e5?"warning":""};c.addHandler("tasks",{group:function(e){e?r.html($("<div>",{class:"panel"}).append($("<h2>",{class:"row",text:view.prettyId(e.specialId)}))):r.empty()},invitationPairs:function(e){if(_.isArray(e)&&2===e.length){var n=e[0],t=e[1],i=[];_.forEach(n,function(e){var n=new Date(e.duedate),t=n.toLocaleDateString("en-GB",{hour:"numeric",minute:"numeric",day:"2-digit",month:"short",year:"numeric"});e.web&&i.push($("<div>",{class:"row"}).append($("<a>",{href:"/invitation?id="+e.id,text:view.prettyId(e.id),style:"font-size: 1rem;font-weight: bold;"}),$("<div>",{class:"invitation_duedate",text:"Due: "+t}).addClass(g(n))))}),_.forEach(t,function(e){var n=e.invitation,t=e.replytoNote,r=new Date(n.duedate),a=r.toLocaleDateString("en-GB",{hour:"numeric",minute:"numeric",day:"2-digit",month:"short",year:"numeric"});i.push($("<div>",{class:"row"}).append($("<div>").append(view.mkNotePanel(t,{invitation:n,titleLink:"HREF",withReplyCount:!0}).removeClass("panel")),$("<div>").append($("<a>",{text:view.prettyInvitationId(n.id),href:"/forum?"+$.param({id:n.reply.forum,noteId:n.reply.replyto,invitationId:n.id})}),$("<div>",{class:"invitation_duedate",text:"Due: "+a}).addClass(g(r)))))});var r=$("<div>",{text:"Outstanding Tasks",class:"small_heading"});a.html($("<div>",{class:"panel"}).append(i.length?_.flatten([[r],i]):$("<div>",{text:"No outstanding tasks"})))}},paperNotes:function(n){var t=$("<div>",{text:"Papers",class:"small_heading"}),i=_.map(n,function(n){return e(n,!1,o)});s.html($("<div>",{class:"panel"}).append(i.length>0?_.flatten([[t],i]):[]))},replyNotes:function(n){var t=$("<div>",{text:"Comments and reviews",class:"small_heading"}),i=_.map(n,function(n){return e(n,!0,o)});l.html($("<div>",{class:"panel"}).append(i.length>0?_.flatten([[t],i]):[]))},trashNotes:function(n){if(_.isArray(n)){var t=$("<div>",{text:"Trash",class:"small_heading"}),i=_.map(n,function(n){return e(n,!1,o)});i.length||i.push($("<div>",{text:"Nothing in the trash"})),d.html($("<div>",{class:"panel"}).append(_.flatten([[t],i])))}}})}else controller.removeHandler("tasks"),replaceWithLogin()}})};Handlebars.registerHelper("truncate",function(e,n){if("string"==typeof(e=Handlebars.Utils.escapeExpression(e))&&e.length>n&&n>0){var t=(e+=" ").substr(0,n),i=t.lastIndexOf(" ");return-1!==i&&i>Math.floor(.75*n)&&(t=e.substr(0,i)),new Handlebars.SafeString(t+"&hellip;")}return new Handlebars.SafeString(e)}),Handlebars.registerHelper("toLowerCase",function(e){return e&&_.isString(e)?e.toLowerCase():""}),Handlebars.registerHelper("encodeURI",function(e){return e&&_.isString(e)?encodeURIComponent(e):""}),Handlebars.registerHelper("upperFirst",function(e){return e&&_.isString(e)?_.upperFirst(e):""}),Handlebars.registerHelper("join",function(e,n,t,i){var r=[].concat(e);return n="string"==typeof n?n:", ",t=t||0,i=i||r.length,r.slice(t,i).join(n)}),Handlebars.registerHelper("prettyId",function(e){return"string"==typeof e?view.prettyId(e):""}),Handlebars.registerHelper("prettyInvitationId",function(e){return"string"==typeof e?view.prettyInvitationId(e):""}),Handlebars.registerHelper("prettyField",function(e){return"string"!=typeof e?"":_.map(e.replace(/_/g," ").split(" "),function(e){return e.charAt(0).toUpperCase()+e.substring(1)}).join(" ").trim()}),Handlebars.registerHelper("pdfUrl",function(e,n){if(!e.content)return"";var t=n?"/references/pdf":"/pdf";return _.startsWith(e.content.pdf,"/pdf")?t+"?id="+e.id:e.content.pdf}),Handlebars.registerHelper("forumDate",function(e,n){var t={day:"2-digit",month:"short",year:"numeric"},i=new Date(e).toLocaleDateString("en-GB",t),r="";return n&&e!==n&&(r=" (modified: "+new Date(n).toLocaleDateString("en-GB",t)+")"),i+r}),Handlebars.registerHelper("modifiedDate",function(e){var n={day:"2-digit",month:"short",year:"numeric",hour:"numeric",minute:"numeric"};return new Date(e).toLocaleDateString("en-GB",n)}),Handlebars.registerHelper("noteAuthors",function(e,n){var t="";return _.isArray(e)&&e.length&&(t=_.isArray(n)&&n.length?e.map(function(e,t){var i;return e=Handlebars.Utils.escapeExpression(e),(i=Handlebars.Utils.escapeExpression(n[t]))&&0===i.indexOf("~")?'<a href="/profile?id='+encodeURIComponent(i)+'" class="profile-link" data-toggle="tooltip" data-placement="bottom" title="'+i+'">'+e+"</a>":i&&-1!==i.indexOf("@")?'<a href="/profile?email='+encodeURIComponent(i)+'" class="profile-link" data-toggle="tooltip" data-placement="bottom" title="'+i+'">'+e+"</a>":e}).join(", "):e.map(function(e,n){return Handlebars.Utils.escapeExpression(e)}).join(", ")),new Handlebars.SafeString(t)}),Handlebars.registerHelper("noteContentCollapsible",function(e){if(_.isEmpty(e))return"";var n=_.omit(e.content,["body","title","authors","author_emails","pdf","verdict","paperhash","_dblp","_bibtex"]),t=Handlebars.templates.noteContent(n),i=e.id+"-details-"+Math.floor(1e3*Math.random()),r='<a href="#'+i+'" class="note-contents-toggle" role="button" data-toggle="collapse" aria-expanded="false">Show paper details</a><div class="collapse" id="'+i+'"><div class="note-contents-collapse">'+t+"</div></div>";return new Handlebars.SafeString(r)}),Handlebars.registerHelper("tagWidget",function(e,n){if(n=n||[],!_.has(e,"reply.content.tag.value-dropdown"))return"";var t=_.find(n,function(n){return n.invitation===e.id}),i={placeholder:"No Bid",readOnly:!1},r=Handlebars.templates.tagWidget_bid({tag:{id:t?t.id:null,invitationId:e.id,value:t?t.tag:null,options:e.reply.content.tag["value-dropdown"]},options:i});return new Handlebars.SafeString(r)}),Handlebars.registerHelper("forumReaders",function(e){return _.isArray(e)?_.includes(e,"everyone")?"everyone":_.map(e,view.prettyId).join(", "):e}),Handlebars.registerHelper("inflect",function(e,n,t,i){var r=1===(e="number"==typeof e?e:0)?n:t;return i?e+" "+r:r}),Handlebars.registerHelper("is",function(e,n,t){return 2===arguments.length&&(n=(t=n).hash.compare),e===n?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("isnt",function(e,n,t){return 2===arguments.length&&(n=(t=n).hash.compare),e!==n?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("debug",function(e){console.log("Current Context"),console.log("===================="),console.log(this),e&&(console.log("Value"),console.log("===================="),console.log(e))}),Handlebars.registerPartial("noteBasic",Handlebars.templates["partials/noteBasic"]),Handlebars.registerPartial("noteList",Handlebars.templates["partials/noteList"]),Handlebars.registerPartial("spinner",Handlebars.templates.spinner);var view=function(){function e(e,n,t){var i=$("<span>",{text:"*",class:"required_field"});if(_.has(e,"values-regex"))controller.get("groups",{regex:e["values-regex"]},function(r){if(_.isEmpty(r.groups))t(void 0,"no_results");else{var a=_.filter(r.groups,function(e){return"everyone"===e.id}),o=_.sortBy(_.filter(r.groups,function(e){return"everyone"!==e.id}),function(e){return e.id}),s=v("readers",e,n,{groups:a.concat(o)});t(s.prepend(i))}},function(e){t(void 0,e)});else{var r=v("readers",e,n);t(r.prepend(i))}}function n(e,n,t,i){var r=function(r){if(_.isEmpty(r.groups))i(void 0,"no_results");else{var a=[];if(r.groups.length>1){var o=_.filter(r.groups,function(e){return e.members&&1===e.members.length&&e.members[0]===t.profile.id});1===o.length&&(a=[o[0].id])}_.isEmpty(a)&&(a=_.map(r.groups,function(e){return e.id}));var s=m("signatures",e.description,n&&n[0],a,!0);i(s)}},a=function(e){i(void 0,e)};if(_.has(e,"values-regex"))"~.*"===e["values-regex"]?t&&t.profile?r({groups:[{id:t.profile.id}]}):a("no_results"):controller.get("groups",{regex:e["values-regex"],signatory:t.id},r,a);else{var o=v("signatures",e,n);i(o)}}var t=function(e,n,t,i,r,a){a=a||"";var o=t,s=t;t&&_.isObject(t)&&(o=t.description,s=t.id);var l={readonly:n||!1,placeholder:e,class:"form-control",value:o,value_id:s},d=$("<div>",{class:"dropdown "+a}).append($("<input>",l),$("<div>",{class:"dropdown_content"}).hide()),p=d.find("input");i&&(p.click(function(){i(c,"")}),p.keydown(function(e){if(40===e.keyCode)return d.find(".dropdown_content").find("div").first().focus(),!1}),n||(p.keyup(function(){i(c,p.val(),p.attr("value_id"))}),p.focusout(function(){r&&r(p.val(),p.attr("value_id"),!0)})));var c=function(e){var t=_.map(e,function(e){return _.isString(e)?{id:e,description:view.prettyId(e)}:e});$(".dropdown .dropdown_content").empty().hide();var i=d.find(".dropdown_content").empty();t.length>0&&(i.append(_.map(t,function(e){return $("<div>",{text:e.description,tabindex:"0"}).click(function(){p.val(e.description),p.attr("value_id",e.id),i.hide(),i.empty(),r&&r(e.description,e.id)}).keydown(function(n){13===n.keyCode&&(p.val(e.description),p.attr("value_id",e.id),i.hide(),i.empty(),r&&r(e.description,e.id))}).focus(function(t){$(this).addClass("active").siblings().removeClass(),!n&&r&&r(e.description,e.id,!0)})})),i.on("keydown","div",function(e){var n=$(this);return 40===e.keyCode?(n.next().focus(),!1):38===e.keyCode?(0===n.index()?p.focus():n.prev().focus(),!1):void 0}),i.show())};return d},i=function(e,n,t,i){var s,l;if(!n){var d=t.length&&t[0].signatures[0];return s={id:"values-text"+i.forum,type:"text",value:_.map(t,function(e){return H(e.tag)}).join(", ")},l={placeholder:i.placeholder,label:i.label||H(t[0].invitation)+" ["+H(d)+"]",onChange:i.onChange,readonly:!0},o(s,l)}return _.has(n,"value-dropdown")?(s={id:t.length&&t[0].id,options:n["value-dropdown"],value:t.length&&t[0].tag},l={placeholder:i.placeholder,onChange:i.onChange},r(s,l)):_.has(n,"values-url")?(s={id:"values-url"+i.forum,optionsUrl:n["values-url"],value:_.map(t,function(e){return{id:e.id,tag:e.tag,name:H(e.tag)}})},l={placeholder:i.placeholder,onChange:i.onChange},a(s,l)):_.has(n,"value-regex")?(s={id:t.length&&t[0].id,type:"text",value:t.length&&t[0].tag},l={placeholder:i.placeholder,label:i.placeholder,onChange:i.onChange,readonly:!1},o(s,l)):null},r=function(e,n){var t={placeholder:"",readOnly:!1,onChange:null};n=_.assign(t,n);var i=Handlebars.templates.tagWidget_bid,r=$(i({tag:e,options:n}));return $(".dropdown-menu li a",r).click(function(){var e=$(this).text();return $("button.dropdown-toggle .bid-value",r).text(e),$("button.dropdown-toggle",r).click(),r.removeClass("incomplete"),n.onChange&&n.onChange(r.data("id"),e,!1,function(e){r.data("id",e.id)}),!1}),r},a=function(e,n){var i={placeholder:"",readOnly:!1,onChange:null};n=_.assign(i,n);var r=Handlebars.templates.tagWidget_recommend,a=$(r({tag:e,options:n})),o=[],s=function(e,n){var t=[];return $(".selected-reviewer",a).each(function(e){t.push($(this).data("tag"))}),_.filter(e,function(e){return!_.includes(t,e.id)&&-1!==e.description.toLowerCase().indexOf(n.toLowerCase())})},l=t(n.placeholder,!1,{},function(n,t){o.length?n(s(o,t)):controller.get(e.optionsUrl,{},function(e){var i=e.groups[0];o=_.map(i.members,function(e){return{id:e,description:H(e)}}),n(s(o,t))})},function(e,t,i){i||($(".dropdown-container",a).before('<span class="selected-reviewer" data-tag="'+t+'">'+e+' <a href="#" title="Delete recommendation"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a></span>'),$(".dropdown input",a).val("").focus(),n.onChange&&n.onChange(void 0,t,!1,function(e){$(".selected-reviewer",a).last().data("id",e.id)}))});return $(".dropdown-container",a).append(l),a.on("click",".show-reviewer-dropdown",function(){return $(".dropdown-container",a).show(),$(this).hide(),$(".hide-reviewer-dropdown",a).show(),!1}),a.on("click",".selected-reviewer a",function(){if($(this).parent().fadeOut("fast",function(){$(this).remove()}),n.onChange){var e=$(this).parent().data("id"),t=$(this).parent().data("tag");n.onChange(e,t,!0,function(){})}return!1}),a.on("click",".hide-reviewer-dropdown",function(){return $(".dropdown-container",a).hide(),$(this).hide(),$(".show-reviewer-dropdown",a).show(),!1}),a},o=function(e,n){var t={placeholder:"",readOnly:!1,onChange:null};n=_.assign(t,n);var i=Handlebars.templates.tagWidget_text,r=$(i({tag:e,options:n})),a=function(){var e="Edit"===$(".toggle-edit-value",r).text()?"Save":"Edit";if($(".toggle-edit-value",r).text(e),$(".current-value",r).toggle(),$(".new-value",r).toggle(),"Edit"===e){var t=$(".new-value",r).val();$(".current-value",r).text(t),n.onChange&&n.onChange(r.data("id"),t,!1,function(e){r.data("id",e.id)})}return!1};return n.readonly?$(".toggle-edit-value",r).hide():(r.on("click",".toggle-edit-value",a),r.on("submit","form",a)),r},s=function(e,n){var t=$("<span>",{class:"removable_item"}).append($("<span>",{class:"removable_item_content",text:e,value_id:n}),$("<span>",{class:"removable_item_button glyphicon glyphicon-remove-circle"}).click(function(){t.remove()}));return t},l=function(e,n,i,r,a,o){var l=a?t(e,!1,void 0,a,function(e,n,t){if(o(e,n)&&!t){var i=r?p(e,n,!0):s(e,n);d.append(i),l.find("input").val("")}}):null,d=$("<div>",{class:"list_adder_list"});return d.append(_.map(_.difference(n,i),function(e){return r?p(e.description,e.id):h(e.description)})),d.append(_.map(i,function(e){return r?p(e.description,e.id):s(e.description,e.id)})),[d,$("<div>",{class:"list_adder"}).append(l)]},d=function(e,n,t,i,r){var a=p($("<span>",{text:e,class:"line_heading"}),n,!1,!0,r.required),o=$("<div>",{class:"row"}).append(a),s=_.map(t,function(e){return{id:e,description:view.prettyId(e)}}),d=s,u=function(e,n){var t=[],i=[];return _.forEach(s,function(n){_.includes(e,n.id)?t.push(n):i.push(n)}),n?t:i},f=r.refreshData&&s.length>1,m=f?[]:s,v=f?function(e,n){var t=c(o);e(function(e,n){return _.filter(e,function(e){return _.includes(e.description.toLowerCase(),n.toLowerCase())})}(d=u(t),n))}:void 0,h=r.hoverText||!f,g=u(i||[],!0);return o.append(l(e,m,g,h,v,function(e,n){var t=_.find(d,["id",n]),i=o.find("input");return t&&t.description===e?(i.val(e),i.attr("value_id",n),!0):(i.val(""),i.attr("value_id",""),!1)}))},p=function(e,n,t,i,r){var a=i?"hover_title":"hover_item",o=$("<div>",{class:t?a+" removable_item":a});if(_.isString(n)&&n.length>0){var s=$("<div>",{class:"hover_result"}).text(n).hide();o.append(s).hover(function(){s.show()},function(){s.hide()})}var l=$("<div>",{class:"hover_target"}).append(e);return r&&l.prepend($("<span>",{text:"*",class:"required_field"})),o.append(l),t&&l.append($("<span>",{class:"removable_item_button glyphicon glyphicon-remove-circle"}).click(function(){o.remove()})),o.append(l),o},c=function(e){var n=[];return e.find(".item").each(function(){n.push($(this).text())}),e.find(".removable_item_content").each(function(){n.push($(this).attr("value_id"))}),e.find(".list_adder_list .hover_result").each(function(){n.push($(this).text())}),e.find(".dropdown.note_content_value").each(function(){_.isEmpty($(this).val())||n.push($(this).attr("value_id"))}),n},u=function(e,n){var t=$("<span>",{class:"removable_pair"}).append($("<span>",{class:"removable_pair_content"}).append($("<span>",{class:"removable_pair_key",text:e}),$("<span>",{text:" = "}),$("<span>",{class:"removable_pair_val",text:n})),$("<span>",{class:"removable_pair_button glyphicon glyphicon-remove-circle"}).click(function(){t.remove()}));return t},f=function(e,n,t,i){var r=function(t){var i=$("<div>",{text:e,class:"small_heading"});if(_.has(n,"required")&&n.required){var r=$("<span>",{text:"*",class:"required_field"});i.prepend(r)}return $("<div>",{class:"row"}).append(i,$("<div>",{text:n.description,class:"hint"}),t)};if(_.has(n,"value"))return r($("<input>",{type:"text",class:"form-control note_content_value",name:e,value:n.value,readonly:!0}));if(_.has(n,"value-regex")){var a=n["value-regex"],o=new RegExp("^"+a+"$"),s="\n".match(o);return r(s&&s.length>0?$("<textarea>",{class:"note_content_value form-control",name:e,text:t}):$("<input>",{type:"text",class:"form-control note_content_value",name:e,value:t}))}if(_.has(n,"value-dropdown"))return m(e,n.description,t,n["value-dropdown"],n.required);if(_.has(n,"values-dropdown"))return d(e,n.description,n["values-dropdown"],t,{hoverText:!1,refreshData:!0,required:n.required});if(_.has(n,"value-radio"))return r(_.map(n["value-radio"],function(n){return $("<div>").append($("<input>",{type:"radio",name:e,id:n,value:n,checked:t===n,class:t===n?"note_content_value":""}).click(function(){$('input[name="'+e+'"]:checked').addClass("note_content_value"),$('input[name="'+e+'"]:not(:checked)').removeClass("note_content_value")}),$("<label>",{for:n.toString(),class:"item"}).text(n))}));if(_.has(n,"values"))return d(e,n.description,n.values,t,{hoverText:!0,refreshData:!1});if(_.has(n,"values-regex")){if(i&&i.groups){var l=i.groups,p=_.map(l,function(e){return e.id});return d(e,n.description,p,t,{hoverText:!1,refreshData:!0})}return r($("<input>",{type:"text",class:"form-control note_content_value",name:e,value:t}))}return _.has(n,"value-copied")?r($("<span>",{display:"hidden",type:"text",class:"note_content_value",name:e,value:n["value-copied"]})).removeClass("row").css("visibility","hidden").height(0):_.has(n,"values-copied")?r($("<span>",{display:"hidden",type:"text",class:"note_content_value",name:e,value:n["values-copied"]})).removeClass("row").css("visibility","hidden").height(0):void 0},m=function(e,n,i,r,a){var o=$("<div>",{class:"row"}).append(p($("<span>",{text:e,class:"line_heading"}),n,!1,!0,a));if(1===r.length)o.append(p(H(r[0]),r[0]).addClass("list_adder_list"));else{var s=_.map(r,function(e){return{id:e,description:view.prettyId(e)}}),l=_.find(s,["id",i]),d=function(e,n){return _.filter(e,function(e){return _.includes(e.description.toLowerCase(),n.toLowerCase())})},c=t(e,!1,l,function(e,n){e(d(s,n))},function(e,n){var t=_.find(s,["id",n]),i=c.find("input");t&&t.description===e?(i.val(e),i.attr("value_id",n)):(i.val(""),i.attr("value_id",""))});c.find("input").attr({class:"form-control dropdown note_content_value",name:e}),o.append(c)}return o},v=function(e,n,t,i){return"pdf"===e?w(n,t):f(e,n,t,i)},h=function(e,n){var t=$("<div>",{class:"item",text:e});return n?t.addClass("button").click(n):t},g=function(e,n){return $("<div>",{class:"section"}).append(e?$("<div>",{class:"section_title",text:e}):null,n)},y=function(e){return"upload"===e.toLowerCase()?"upload":_.startsWith(e.toLowerCase(),"upload|")?"either":"url"},b=function(e){var n=e.data.regexStr,t=$(".note_pdf").val();if(t.indexOf("arxiv.org/pdf/")>-1&&t.match(n)){$(".row:has(.note_pdf) .load_error").remove();var i=t.split("arxiv.org/pdf/")[1].split(".pdf")[0];$.ajax({url:"http://export.arxiv.org/api/query?id_list="+i,dataType:"xml",success:function(e){var n=$(e);if(n.find("entry")){var t=n.find("entry")[0],i={};if(t.getElementsByTagName("title")&&(i.title=t.getElementsByTagName("title")[0].childNodes[0].nodeValue),t.getElementsByTagName("summary")&&(i.abstract=t.getElementsByTagName("summary")[0].childNodes[0].nodeValue.replace(/\n/g," ").trim()),t.getElementsByTagName("author")){for(var r=[],a=t.getElementsByTagName("author"),o=0;o<a.length;o++){var s=a[o].childNodes[1].childNodes[0].nodeValue;r[o]=s}i.authors=r.join(", ")}for(var l in i)$(".note_content_value[name="+l+"]").val(i[l])}$(".row:has(.note_pdf) i").remove()},error:function(){$(".row:has(.note_pdf) i").remove(),$(".row:has(.note_pdf)").append($("<span>",{text:"arXiv autofill failed",class:"load_error hint"})),$(".note_content_value").val("")}})}},w=function(e,n){var t=e.description,i=e.order,r=e["value-regex"],a=y(r),o=function(e){var n=$("<input>",{type:e,class:"form-control note_pdf"});return"text"===e&&i<=1&&n.keyup({regexStr:r},b),n},s=function(i){var r=$("<div>",{text:"pdf",class:"small_heading"});if(_.has(e,"required")&&e.required){var a=$("<span>",{text:"*",class:"required_field"});r.prepend(a)}return $("<div>",{class:"row"}).append(r,$("<div>",{text:t,class:"hint"}),$("<input>",{class:"note_content_value",name:"pdf",value:n,style:"display: none;"}),i,n?$("<span>").append($("<a>",{href:n,text:"pdf",target:"_blank"}),$("<span>",{class:"item hint",text:" ("+n+") "}).css("margin-left","6px")):null)};if("upload"===a)return s(o("file"));if("url"===a)return s(o("text"));if("either"===a){var l=$("<span>"),d=Date.now();return s([$("<div>",{class:"item"}).append($("<div>").append($("<input>",{class:"upload",type:"radio",name:"pdf_"+d}).click(function(){l.html(o("file"))}),$("<span>",{class:"item",text:"Upload PDF file"})),$("<div>").append($("<input>",{class:"url",type:"radio",name:"pdf_"+d}).click(function(){l.html(o("text"))}),$("<span>",{class:"item",text:"Enter PDF URL"}))),l])}},k=function(e,n,t){e.empty(),e.append(w(n,t).children())},x=function(e){return"readers: "+(_.includes(e,"everyone")?"everyone":_.map(e,function(e){return H(e)}).join(", "))},C=function(e){return _.map(_.sortBy(_.map(e,function(n,t){var i=_.has(n,"order")?parseInt(n.order):NaN;return isNaN(i)?[t,_.keys(e).length]:[t,i]}),function(e){return e[1]}),function(e){return e[0]})},E=function(e){var n=/(?:(?:https?|ftp|file):\/\/|www\.|ftp\.)(?:\([-A-Z0-9+&@#/%=~_|$?!:,.]*\)|[-A-Z0-9+&@#/%=~_|$?!:,.])*(?:\([-A-Z0-9+&@#/%=~_|$?!:,.]*\)|[A-Z0-9+&@#/%=~_|$])/gim;return e.replace(n,function(e){return'<a href="'+e+'">'+e+"</a>"})},S=function(e,n){var t=n?"/references/pdf":"/pdf";return _.startsWith(e.content.pdf,"/pdf")?t+"?id="+e.id:e.content.pdf},H=function(e){var n=["everyone","(anonymous)","(guest)"],t=["conference","workshop","submission","recommendation","paper","review","reviewer","reviewers","official","public","meta","comment","question","acceptance","pcs"];if(e){if(0===e.indexOf("~"))return e.substring(1).replace(/_|\d+/g," ").trim();if(_.includes(n,e))return e;if(-1===e.indexOf("/"))return e;var i=e.split("/");return _.without(_.map(i,function(e){return(e=(e=(e=e.replace(/\..+/g,"")).replace(/^-$/g,"")).replace(/_/g," ")).replace(/[^aA-zZ]/g,"").match(/^[a-z]+$/g)&&!_.includes(t,e)&&(e=""),e}),"").join(" ")}return""},R=function(e){if(!e)return"";var n=e.split("/").slice(-2);return(n=n.map(function(e){return e.replace(/^-$/g,"").replace(/_/g," ").replace(/Paper\d+/g,"").trim()}).filter(function(e){return!!e})).join(" ")},N=function(e,n){var t=_.cloneDeep(e);return I(t,n,e),t},I=function(e,n,t){_.mapKeys(n,function(n,i){if(_.has(n,"value-copied")){var r=_.get(n,"value-copied").replace(/{|}/g,"");e[i]=_.get(t,r)}_.has(n,"values-copied")&&_.get(n,"values-copied").forEach(function(n){if(_.startsWith(n,"{")){var r=n.replace(/{|}/g,"");e[i]=_.union(e[i]||[],_.get(t,r))}else e[i]=_.union(e[i]||[],[n])}),"object"!=typeof n||_.isUndefined(e)||I(e[i],n,t)})},O=function(e,n){var t=[],i=e.reply.content;return i.pdf&&e.reply.content.pdf.required&&(!n.pdf||_.endsWith(n.pdf,".pdf")||_.startsWith(n.pdf,"/pdf")||t.push("Uploaded file must have .pdf extension"),n.pdf||("upload"===i.pdf["value-regex"]?t.push("You must provide a PDF (file upload)"):i.pdf["value-regex"].includes("upload")?t.push("You must provide a PDF (either by URL or file upload)"):t.push("You must provide a PDF (URL)"))),t},P=function(e,n){var t=[];if(e&&"everyone"!==e&&n.id.match(new RegExp("ICLR.cc/2017/conference/-/paper[0-9]+/(official|public)/comment"))){var i=$("div #note_"+n.reply.forum+' .note_contents:contains("Authorids") > .note_content_value').text();t=_.map(i.split(","),function(e){return e.trim()})}return t},T=function(e,n){var t=_.reduce(e.reply.content,function(e,t,i){var r=n[i].find('.note_content_value[name="'+i+'"]').val();if("values-dropdown"in t&&(r=c(n[i])),"values-regex"in t){var a=r.split(",");r=_.filter(_.map(a,function(e){return e.trim()}),function(e){return!_.isEmpty(e)})}return r&&(e[i]=r),e},{}),i=n.pdf,r=i&&i.find('input.note_pdf[type="file"]'),a=r&&r.val()?r[0].files[0]:null,o=i&&i.find('input.note_pdf[type="text"]'),s=o&&o.val();return r&&(a||s)&&(t=_.assign(t,{pdf:a?a.name:s})),[t,a]},L=function(e,n,t){return e.reply.writers&&_.has(e.reply.writers,"values")?e.reply.writers.values:e.reply.writers&&_.has(e.reply.writers,"values-regex")&&"~.*"===e.reply.writers["values-regex"]?[t.profile.id]:n},D=function(e){return e.cdate?new Date(e.cdate):e.tcdate?new Date(e.tcdate):new Date};return{mkDropdown:t,mkMapAdder:function(e,n){var t=$("<input>",{type:"text"}),i=$("<input>",{type:"text"}),r=$("<div>",{class:"map_adder"});return r.append(_.map(n,function(e,n){return u(n,e)})),g(e,[r,$("<div>",{class:"map_adder"}).append(t,i,$('<button class="btn map_adder_button">',{text:"Add"}).click(function(){var e=u(t.val(),i.val());r.append(e),t.val(""),i.val("")}))])},mapFromMapAdder:function(e){var n=Object.create(null);return e.find(".removable_pair_content").each(function(){var e=$(this),t=e.find(".removable_pair_key").first().text(),i=e.find(".removable_pair_val").first().text();n[t]=i}),n},mkInputSection:function(e,n,t){return g(e,$("<input>",{class:"form-control input_section_input",name:e,type:t?"password":"text",value:n||""}))},valFromInputSection:function(e){return e.find("input").val()},mkComposerInput:v,mkComposerContentInput:f,mkNewNoteEditor:function(t,i,r,a,o){function s(e,n){var o=$('<button class="btn btn-sm">Submit</button>'),s=$('<button class="btn btn-sm">Cancel</button>');o.click(function(){o.prop({disabled:!0}).append(['<div class="spinner-small">','<div class="rect1"></div><div class="rect2"></div>','<div class="rect3"></div><div class="rect4"></div>',"</div>"].join("\n")),s.prop({disabled:!0});var l=T(t,p),d=c(n),f=c(e),m=null;t.reply.nonreaders&&_.has(t.reply.nonreaders,"values")&&(m=t.reply.nonreaders.values),m=_.union(m,P(f,t));var v=L(t,d,a),h=O(t,l[0]),g=l[1];if(_.isEmpty(h)){var $={content:l[0],readers:f,nonreaders:m,signatures:d,writers:v,invitation:t.id,forum:i||t.reply.forum,replyto:r||t.reply.replyto};g?controller.sendFile("pdf",g).then(function(e){$.content.pdf=e.url,k(p.pdf,t.reply.content.pdf,$.content.pdf),u($)},function(){promptError("There was an error uploading the file"),o.prop({disabled:!1}).find(".spinner-small").remove(),s.prop({disabled:!1})}):u($)}else{for(var y=0;y<h.length;y++)promptError(h[y]);o.prop({disabled:!1}).find(".spinner-small").remove(),s.prop({disabled:!1})}}),s.click(function(){m.remove()});var d=$("<div>",{class:"row"}).append(o,s),u=function(e){e=N(e,t.reply),controller.post("notes",e,function(e){l.onNoteCreated&&l.onNoteCreated(e),m.remove()},function(e,n,t){if(o.prop({disabled:!1}).find(".spinner-small").remove(),s.prop({disabled:!1}),l.onError)l.onError(e,n,t);else{var i=e.responseJSON?e.responseJSON.errors:null;promptError(i.length?i[0]:"Something went wrong")}})},f=$("<div>",{class:"required_field",text:"* denotes a required field"}),m=$("<div>",{class:"note_editor panel"}).append(f,_.values(p),e,n,d);l.onCompleted&&l.onCompleted(m)}$(".note_editor.panel").remove();var l=_.assign({onNoteCreated:null,onCompleted:null,onError:null},o),d=C(t.reply.content),p=_.reduce(d,function(e,n){return e[n]=v(n,t.reply.content[n],""),e},{});e(t.reply.readers,[],function(e){n(t.reply.signatures,[],a,function(n,t){n?s(e,n):promptError(_.isEqual(t,"no_results")?"You don't have permission to create a note.":t)})})},mkNoteEditor:function(t,i,r,a){function o(e,n){var a=$('<button class="btn btn-sm">Submit</button>'),o=$('<button class="btn btn-sm">Cancel</button>'),l=$("<div>",{class:"row"}).append(a.click(function(){var a=T(i,d),o=c(n),l=c(e),u=null;i.reply.nonreaders&&_.has(i.reply.nonreaders,"values")&&(u=i.reply.nonreaders.values);var f=L(i,o,r),m=O(i,a[0]),v=a[1];if(m.length)for(var h=0;h<m.length;h++)promptError(m[h]);else{var g={content:a[0],readers:l,nonreaders:u,signatures:o,writers:f,invitation:i.id,forum:t.forum||i.reply.forum,replyto:t.replyto||i.reply.replyto||i.reply.forum};i.reply.referent?g.referent=i.reply.referent:g.id=t.id,v?controller.sendFile("pdf",v).then(function(e){g.content.pdf=e.url,k(d.pdf,i.reply.content.pdf,g.content.pdf),p(g)},function(e){s.onError?s.onError(e):promptError("There was an error uploading the file")}):p(g)}}),o.click(function(){s.onNoteCancelled()})),p=function(e){e=N(e,i.reply),a.prop({disabled:!0}),o.prop({disabled:!0}),controller.post("notes",e,function(e){s.onNoteEdited&&s.onNoteEdited(e),f.remove()},function(e,n,t){if(a.prop({disabled:!1}).find(".spinner-small").remove(),o.prop({disabled:!1}),s&&s.onError)s.onError(e,n,t);else{var i=e.responseJSON?e.responseJSON.errors:null;promptError(i.length?i[0]:"Something went wrong")}})},u=$("<div>",{class:"required_field",text:"* denotes a required field"}),f=$("<div>",{class:"note_editor panel"}).append(u,_.values(d),e,n,l);s.onCompleted&&s.onCompleted(f)}$(".note_editor.panel").remove();var s=_.assign({onNoteEdited:null,onNoteCancelled:null,onError:null},a),l=C(i.reply.content),d=_.reduce(l,function(e,n){return e[n]=v(n,i.reply.content[n],t&&t.content[n]||""),e},{});e(i.reply.readers,t.readers,function(e){n(i.reply.signatures,t.signatures,r,function(n){o(e,n)})})},mkNotePanel:function(e,n){var t=_.assign({invitation:null,onEditRequested:null,replyInvitations:[],referenceInvitations:[],tagInvitations:[],originalInvitations:[],onNewNoteRequested:null,titleLink:"NONE",withContent:!1,withReplyCount:!1,withRevisionsLink:!1,withParentNote:!1,onTrashedOrRestored:null,isReference:!1,withModificationDate:!1,withDateTime:!1,withBibtexLink:!0},n),r=$("<div>",{id:"note_"+e.id,class:"note panel"}),a=e.forum,o=!!e.ddate&&e.ddate<Date.now();o&&r.addClass("trashed");var s=_.has(e.content,"title"),l=_.has(e.content,"verdict"),d=$('<h2 class="note_content_title">');if(s||l){var p=null;"HREF"===t.titleLink&&(p="/forum?id="+a,a!==e.id&&(p+="&noteId="+e.id));var c={href:p,text:s?""===e.content.title.trim()?"No Title":e.content.title:"Verdict: "+e.content.verdict};d.append($("<a>",c)),"JS"===t.titleLink&&d.click(function(){controller.removeAllButMain(),pushForum(a,e.id)})}var u=null,f=null;if(e.content.pdf){var m=S(e,t.isReference);u=$("<a>",{class:"note_content_pdf",href:m,title:"Download PDF",target:"_blank"}).append('<img src="/static/images/pdf_icon_blue.svg">')}(e.content.ee||e.content.url)&&(f=$("<a>",{class:"note_content_pdf html-link",href:e.content.ee||e.content.url,title:"Open Website",target:"_blank"}).append('<img src="/static/images/html_icon_blue.svg">'));var v=$("<div>",{class:"title_pdf_row"}).append(d.append(" ",u," ",f)),h=null;t.withParentNote&&e.forumContent&&e.forum!==e.id&&(h=$('<div class="meta_row parent-title">').append('<span class="item glyphicon glyphicon-share-alt"></span>','<span class="item title">'+e.forumContent.title+"</span>"));var g;g=o?"[Deleted]":_.isArray(e.content.authors)&&e.content.authors.length?_.isArray(e.content.authorids)&&e.content.authorids.length?e.content.authors.map(function(n,t){var i=e.content.authorids[t];return i?0===i.indexOf("~")?'<a href="/profile?id='+encodeURIComponent(i)+'" class="profile-link" data-toggle="tooltip" data-placement="bottom" title="'+i+'">'+n+"</a>":-1!==i.indexOf("@")?'<a href="/profile?email='+encodeURIComponent(i)+'" class="profile-link" data-toggle="tooltip" data-placement="bottom" title="'+i+'">'+n+"</a>":n:n}).join(", "):e.content.authors.join(", "):e.signatures.map(function(e){return 0===e.indexOf("~")?'<a href="/profile?id='+encodeURIComponent(e)+'" class="profile-link">'+H(e)+"</a>":H(e)}).join(", ");var y=$("<span>",{class:"signatures"}).html(g),b=$("<div>",{class:"meta_row"}).append(y),w=e.tauthor&&0===e.tauthor.indexOf("~")?'<a href="/profile?id='+encodeURIComponent(e.tauthor)+'" class="profile-link">'+H(e.tauthor)+"</a>":H(e.tauthor);!e.content.authors&&w&&w!==g&&b.append('<span class="author no-margin">'+w+"</span>",'<span class="private-author-label">(privately revealed to you)</span>');var k=t.withOriginalLink&&e.original?$("<a>",{class:"note_content_pdf item",href:"/forum?id="+e.original,text:"Original",target:"_blank"}):null,I=t.withOverwritingLink&&e.overwriting?$("<a>",{class:"note_content_pdf item",href:"/forum?id="+e.overwriting[0],text:"Submission forum",target:"_blank"}):null,O=t.withRevisionsLink&&e.revisions?$("<a>",{class:"note_content_pdf item",href:"/revisions?id="+e.id,text:"Revisions",target:"_blank"}):null,P=e.content._bibtex&&t.withBibtexLink?$('<span class="item"><a class="action-bibtex-modal" data-bibtex="'+e.content._bibtex+'">Show Bibtex</a></span>'):null,T=null;if(e.writable&&t.onTrashedOrRestored){var L=o?"Restore":'<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>';(T=$('<button id="trashbutton_'+e.id+'" class="btn btn-sm trash_button">').html(L)).click(function(){var n=_.cloneDeep(_.omit(e,"forumContent"));n.ddate=o?null:Date.now(),controller.post("notes",n).then(function(){t.onTrashedOrRestored(n)})})}var M=null;e.writable&&t.onEditRequested&&!o&&(M=$('<button class="btn btn-sm edit_button"><span class="glyphicon glyphicon-edit" aria-hidden="true"></span></button>')).click(function(){t.onEditRequested()});!M&&t.onEditRequested&&t.originalInvitations.length&&(M=$('<button class="btn btn-sm" data-toggle="tooltip" data-placement="left" title="Click here to access the original version of the paper. Changes to the original version will update the anonymous version used by viewers during the review process.">Modifiable Original</button>')).click(function(){pushForum(e.original)}),$("body").hasClass("forum")&&(T&&T.removeClass("btn-sm").addClass("btn-xs"),M&&M.removeClass("btn-sm").addClass("btn-xs"));var U=D(e),j=new Date(e.tmdate),A=_.assign({day:"2-digit",month:"short",year:"numeric"},t.withDateTime&&{hour:"numeric",minute:"numeric"}),B=j.toLocaleDateString("en-GB",A),W=U.toLocaleDateString("en-GB",A),q="";t.withModificationDate&&B!==W&&(q=" (modified: "+B+")");var F=$("<div>",{class:"meta_row"});F.append(!o||e.writable?$("<span>",{class:"date item"}).text(W+q):null,$("<span>",{class:"item"}).text(H(e.invitation)),_.has(e,"readers")?$("<span>",{class:"item"}).text(x(e.readers)):null,t.withReplyCount?$("<span>",{class:"item"}).text(1===e.replyCount?"1 Reply":e.replyCount+" Replies"):null,P,k,I,O);var z=null;if((T||M||t.referenceInvitations)&&((z=$("<div>",{class:"meta_row meta_actions"}).append(M,T)).append(_.map(t.referenceInvitations,function(e){var n=$("body").hasClass("forum")?"btn-xs":"btn-sm";return $('<button class="btn '+n+' edit_button">').text(R(e.id)).click(function(){t.onEditRequested(e)})})),F.addClass("pull-left")),r.append(v,h,b,$('<div class="clearfix">').append(F,z)),t.withContent){var J=_.has(e.content,"body")?$("<div>",{class:"",text:e.content.body}):null,G=function(e){return(e.charAt(0).toUpperCase()+e.substring(1)).replace(/_/g," ").trim()},V=t.invitation?C(t.invitation.reply.content):_.keys(e.content),Y=function(){var n=_.without(V,"body","title","authors","author_emails","authorids","pdf","verdict","paperhash","_dblp","_bibtex");return o?[]:_.map(n,function(n){var t=e.content[n];return _.isNumber(t)||_.isArrayLike(t)&&!_.isEmpty(t)?$("<div>",{class:"note_contents"}).append($("<span>",{class:"note_content_field"}).text(G(n)+": "),$("<span>",{class:"note_content_value"}).html(_.isArray(t)?t.join(", "):E(t))):""})}();if(t.collapseContent){var Z=Math.floor(1e3*Math.random()),X=e.id+"-details-"+Z,K=$('<div class="meta_row"><a href="#'+X+'" class="note-contents-toggle" role="button" data-toggle="collapse" aria-expanded="false">View Paper Details </a></div><div class="collapse" id="'+X+'"><div class="note-contents-collapse"></div></div>');r.append(K),r.find("#"+X+" > div").append(J,Y)}else r.append(J,Y)}var Q=function(n,a){var o=function(e){var n=a.reply[e];return _.has(n,"values")?n.values:(_.has(n,"values-regex")&&_.startsWith(n["value-regex"],"~.*"),[t.user.profile.id])},s=i(0,a&&a.reply.content.tag,n,{forum:e.id,placeholder:a&&R(a.id),onChange:function(n,i,r,s){var l={id:n,tag:i,signatures:o("signatures"),readers:o("readers"),forum:e.id,invitation:a.id,ddate:r?Date.now():null};l=N(l,a.reply),controller.post("tags",l,function(e){s(e),t.onTagChanged&&t.onTagChanged(e)},function(e){var n=_.isEmpty(e.responseJSON.errors)?null:e.responseJSON.errors[0];promptError(n||"The specified bid could not be updated")})}});r.append(s)},ee=_.groupBy(e.tags,"invitation"),ne=[];_.forEach(ee,function(e){var n=e[0].invitation,i=_.find(t.tagInvitations,["id",n]),r=_.groupBy(e,"signatures");_.forEach(r,function(e){i&&_.includes(e[0].signatures,t.user.profile.id)?(Q(e,i),ne.push(i)):Q(e,void 0)})});var te=_.difference(t.tagInvitations,ne);if(_.forEach(te,function(n){(n.reply.invitation||n.reply.forum===e.id)&&Q([],n)}),!_.isEmpty(t.replyInvitations)&&!o){var ie=$("<div>",{class:"reply_row clearfix"}).append('<span class="item hint">Add</span>',_.map(t.replyInvitations,function(e){return $('<button class="btn btn-xs">').text(R(e.id)).click(function(){t.onNewNoteRequested(e)})}));r.append(ie)}return t.withSummary&&r.append($("<div>",{class:"meta_row"}).append($("<span>",{class:"item date"}).text(t.withSummary))),r},mkSection:g,mkBlockItem:function(e,n){var t=$("<div>",{class:"item",text:e});return n?$("<div>").append(t.addClass("button").click(n)):$("<div>").append(t)},mkItem:h,mkListItems:function(e,n,t){return _.map(e,function(e){return h(t?t(e):e,n?function(){n(e)}:null)})},mkSmallHeading:function(e){return $("<div>",{class:"small_heading",text:e})},prettyId:H,truncateTitle:function(e,n){n=n||80;var t=e.indexOf(" ",n);return-1===t?e:e.substring(0,t)+"&hellip;"},mkInvitationButton:function(e,n,t){var i={largeLabel:!1};if(t=_.assign(i,t),!e)return null;var r=$(Handlebars.templates.invitationButton({invitationId:e.id,options:t}));return r.find("button").on("click",n),r},mkHostHeader:function(e,n,t,i,r){return $(Handlebars.templates.venueHeader({title:e,subtitle:n,location:t,website:i,deadline:r,noIcons:!0}))},iTerm:function(e){return $("<span>",{class:"important_term"}).text(e)},iMess:function(e){return $("<span>",{class:"important_message"}).text(e)},prettyInvitationId:R,getCopiedValues:N}}(),Webfield=function(){var e=function(e,t){return controller.get(e,t,null,n,!0)},n=function(e,n){promptError(n),s()},t=function(n,t){var i={pageSize:100,offset:0};(t=_.defaults(t,i)).limit=t.pageSize,t=_.omit(t,"pageSize");var r=_.assign({invitation:n},t);return e("/notes",r).then(function(e){return e.notes})},i=function(n,t,i){var r={pageSize:100,offset:0},a={term:t,content:"all",source:"forum",group:n,limit:(i=_.assign(r,i)).pageSize,offset:i.offset};return e("/notes/search",a).then(function(e){return e.notes})},r=function(e){var n=$("#group-container").data("groupId");return e.subject&&(e.term+=" "+e.subject),i(n,e.term,{pageSize:1e3}).then(e.onResults)},a={pdfLink:!0,htmlLink:!0,replyCount:!0,showContents:!0,showTags:!1,showTasks:!1,tagInvitations:[],emptyMessage:"No papers to display at this time"},o=function(e,n){return n=_.defaults(n,a),_.map(e,function(e){return e.options=n,'<li class="note" data-id="'+e.id+'">'+Handlebars.templates["partials/noteBasic"](e)+"</li>"}).join("\n")},s=function(e){return e=e||"The page could not be loaded at this time. Please try again later.",$("#notes").hide().html('<div class="alert alert-danger"><strong>Error:</strong> '+e+"</div>"),$("#notes").fadeIn("fast")};return{get:e,post:function(e,t){return controller.post(e,t,null,n,!0)},xhrError:n,validate:function(e){return!0},execute:function(e,n){window.user=n;var t=document.createElement("script");return t.type="text/javascript",t.text=["(function(user, window, document) {",e,"})(window.user, null, null);"].join("\n"),document.body.appendChild(t),!0},setupAutoLoading:function(e,n,i){var r={container:"#notes"};i=_.defaults(i,r,a);var s=$(i.container),l=0,d=!1;$(window).off("scroll").on("scroll",_.debounce(function(){d||window.pageYOffset>$(document).height()-window.innerHeight-400&&(l+=n,d=!0,s.append(Handlebars.templates.spinner()),t(e,{pageSize:n,offset:l}).then(function(e){$(".spinner-container",s).remove(),_.isEmpty(e)?$(window).off("scroll"):$(".submissions-list",s).append(o(e,i)),d=!1}))},200))},disableAutoLoading:function(){$(window).off("scroll")},api:{getSubmissionInvitation:function(e,n){var t={duedateBuffer:0};return n=_.assign(t,n),controller.get("/invitations",{id:e},null,function(){},!0).then(function(e){var t=_.filter(e.invitations,function(e){return e.duedate+n.deadlineBuffer>Date.now()});return t.length?t[0]:null},function(){return $.Deferred().resolve(null)})},getSubmissions:t,getTagInvitations:function(n){return e("/invitations",{replyInvitation:n,tags:!0}).then(function(e){return e.invitations})}},ui:{setup:function(e,n){$(e).append('<div id="header"></div>','<div id="invitation"></div>','<div id="notes"></div>'),$(e).data("groupId",n)},header:function(e){return $("#header").html("<h1>"+e+"</h1>"),$("#header")},venueHeader:function(e){return $("#header").hide().html(Handlebars.templates.venueHeader(e)).addClass("venue-header"),$("#header").fadeIn().promise()},submissionButton:function(e,n,t){var i={container:"#invitation",largeLabel:!0,onNoteCreated:function(){console.warn("onNoteCreated option is required")}};t=_.assign(i,t);var r=$(t.container);return r.hide().append(view.mkInvitationButton(e,function(){n&&!_.startsWith(n.id,"guest_")?$(".note_editor",r).length?$(".note_editor",r).slideUp("normal",function(){$(this).remove()}):view.mkNewNoteEditor(e,null,null,n,{onCompleted:function(e){e.hide(),r.append(e),e.slideDown()},onNoteCreated:t.onNoteCreated,onError:function(e,n){promptError(n)}}):promptLogin(n)},t)),r.fadeIn().promise()},submissionList:function(e,n){var t={heading:"Submitted Papers",container:"#notes",search:{enabled:!0,subjectAreas:null,onResults:function(){},onReset:function(){}},displayOptions:a,fadeIn:!0};n=_.defaultsDeep(n,t);var i=$(n.container);if(n.fadeIn&&i.hide(),i.find(".submissions-list").remove(),i.find(".notes-search-form").remove(),_.isEmpty(e)&&(n.search.enabled=!1),i.append(Handlebars.templates["components/submissions"]({heading:n.heading,notes:e,search:n.search,options:n.displayOptions})),n.search.enabled){if(!_.isEmpty(n.search.subjectAreas)){var o=function(e,t,i){if(e&&!i){var a=$(".notes-search-form").find(".search-content input").val().trim().toLowerCase();"All"!==e||a?r({term:a,subject:e,onResults:n.search.onResults}):n.search.onReset()}};$("form.notes-search-form .subject-area").append(view.mkDropdown("Enter a subject area to filter by",!1,"",_.debounce(function(e,t){(t=t.trim().toLowerCase())?e(_.filter(n.search.subjectAreas,function(e){return-1!==e.toLowerCase().indexOf(t)})):(e(n.search.subjectAreas),o(""))},200),_.debounce(o,300),"subject-area-dropdown show-arrow"))}var s=function(){var e=$(".notes-search-form"),t=e.find(".search-content input").val().trim().toLowerCase(),i=e.find(".subject-area-dropdown input"),a="";i.length&&(a=i.val().trim());var o,s=a&&"All"!==a;return t||s?t.length>3&&(o=s?{subject:a}:{},r(_.assign({term:t,onResults:n.search.onResults},o))):n.search.onReset(),!1};i.on("submit","form.notes-search-form",s),i.on("keyup","form.notes-search-form .search-content input",_.debounce(s,200))}n.displayOptions.showTags&&i.on("click",".tag-widget.bid .dropdown-menu li a",function(e){var t=$(this).closest(".tag-widget"),i=$(this).closest(".note"),r=$(this).text(),a=t.data("id")||null,o=t.data("invitationId"),s=_.find(n.displayOptions.tagInvitations,["id",o]),l=[window.user.profile.id].concat(_.filter(s.reply.readers["values-copied"],function(e){return!_.startsWith(e,"{")}));t.find("button.dropdown-toggle .bid-value").text(r),t.find("button.dropdown-toggle").click();var d={id:a,forum:i.data("id"),invitation:s.id,tag:r,signatures:[window.user.profile.id],readers:l,ddate:null};return controller.post("/tags",d,null,function(){},!0).then(function(e){t.data("id",e.id),t.removeClass("incomplete"),t.trigger("bidUpdated",[d])},function(e){var n=_.has(e,"responseJSON.errors")&&!_.isEmpty(e.responseJSON.errors)?e.responseJSON.errors[0]:null;promptError(n||"The specified bid could not be updated. Please reload the page and try again.")}),!1});return n.fadeIn?i.fadeIn("fast").promise():i},taskList:function(e,n,t){var i={container:"#notes",showTasks:!0,emptyMessage:"No outstanding tasks to display"};t=_.defaults(t,i,a);var r={hour:"numeric",minute:"numeric",day:"2-digit",month:"short",year:"numeric"},o=function(e){var n=Date.now()-e.getTime();return n>0?"expired":n>-2592e5?"warning":""},s=[];_.forEach(n,function(e){var n=new Date(e.duedate),t=n.toLocaleDateString("en-GB",r);e.web&&s.push(['<li class="note invitation-link">','<a href="/invitation?id='+e.id+'">'+view.prettyId(e.id)+"</a>",'<span class="duedate '+o(n)+'">Due: '+t+"</span>","</li>"].join("\n"))}),_.forEach(e,function(e){var n=e.invitation,i=e.replytoNote,a=new Date(n.duedate);n.dueDateStr=a.toLocaleDateString("en-GB",r),n.dueDateStatus=o(a),i.taskInvitation=n,i.options=t,s.push(['<li class="note" data-id="'+i.id+'">',Handlebars.templates["partials/noteBasic"](i),"</li>"].join("\n"))});var l=$(t.container),d='<ul class="list-unstyled submissions-list">'+(s.length?s.join("\n"):'<li><p class="empty-message">'+t.emptyMessage+"</p></li>")+"</ul>";l.find(".submissions-list").remove(),l.append(d)},tabPanel:function(e,n){if(n=_.defaults(n,{container:"#notes",hidden:!1}),_.isEmpty(e))console.warn("Missing required parameter for tabPanel: sections");else{var t="";n.hidden&&(t="display: none;");var i=$(n.container),r='<div class="tabs-container" style="'+t+'">'+Handlebars.templates["components/tabs"]({sections:e})+"</div>";i.append(r)}},searchResults:function(e,n){var t={container:"#notes",emptyMessage:"No papers to display at this time"};n=_.defaults(n,t,a);var i=$(n.container),r=Handlebars.templates["partials/noteList"]({notes:e,options:n});i.find(".submissions-list").remove(),i.append(r)},errorMessage:s,spinner:function(e,n){var t={inline:!1,overwrite:!0,extraClasses:null};n=_.defaults(n,t);{if(!_.isEmpty(e)){n.inline&&(n.extraClasses=n.extraClasses?n.extraClasses+" spinner-inline":"spinner-inline");var i=$(e);return n.overwrite&&i.empty(),i.append(Handlebars.templates.spinner({extraClasses:n.extraClasses}))}console.warn("Missing required parameter for spinner: container")}}}}}();
//# sourceMappingURL=openreview.min.js.map